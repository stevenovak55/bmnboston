/**
 * Bridge MLS Extractor Pro - Admin JavaScript
 * Version: 1.1 (Live Extraction Progress)
 * @param $
 */

(function ($) {
  'use strict';

  // Production: Disable debug logging
  const originalLog = console.log;
  console.log = function() {};

  const BME = {
    liveProgressInterval: null,
    currentExtractionId: null,

    /**
     * Initialize admin functionality
     */
    init() {
      this.bindEvents();
      this.initComponents();
      this.loadAsyncStats();
      this.initDatabaseBrowser();
      this.checkAdvancedFiltersValues(); // Auto-expand advanced filters if they have values
      this.initLiveProgressDisplay(); // New: Initialize live progress
      this.initMarketAnalyticsFilters(); // New: Initialize market analytics filters
      this.initMarketAnalyticsCharts(); // New: Initialize market analytics charts
    },

    /**
     * Bind event handlers
     */
    bindEvents() {
      // Confirmation dialogs
      $(document).on('click', '.bme-confirm-clear', this.confirmClear);
      $(document).on('click', '.bme-confirm-resync', this.confirmResync);

      // Filter interactions
      $(document).on('change', '.bme-filter-select', this.handleFilterChange);
      $(document).on('click', '.bme-toggle-advanced-filters', this.toggleAdvancedFilters);
      $(document).on('click', '#bme-advanced-filters', this.toggleAdvancedFilters); // Legacy support

      // AJAX actions
      $(document).on('click', '.bme-load-stats', this.loadExtractionStats);
      $(document).on('submit', '#bme-listings-filter', this.handleFilterSubmit);

      // Real-time updates (already set up, but now also for live progress)
      this.setupRealTimeUpdates();

      // New: Handle Run/Resync button clicks to start live progress polling
      $(document).on(
        'click',
        '#bme-run-extraction-button, #bme-resync-extraction-button',
        this.handleRunButtonClick
      );

      // Property details modal
      console.log('BME: Attaching property details event handlers');
      $(document).on('click', '.bme-view-details', this.handleViewDetails.bind(this));
      $(document).on('click', '.bme-modal-close, .bme-modal-backdrop', this.closePropertyModal);
      console.log('BME: Property details handlers attached successfully');

      // Export modal
      $(document).on('click', '.bme-export-filtered-btn', this.openExportModal.bind(this));
      $(document).on('click', '#bme-export-modal .bme-modal-close', this.closeExportModal);
      $(document).on('click', '#bme-export-modal .bme-modal-backdrop', this.closeExportModal);
    },

    /**
     * Initialize components
     */
    initComponents() {
      // Initialize Select2 dropdowns
      if ($.fn.select2) {
        $('.bme-filter-select').select2({
          allowClear: true,
          placeholder() {
            return $(this).data('placeholder') || 'Select...';
          },
        });
      }

      // Initialize tooltips
      if ($.fn.tooltip) {
        $('[data-tooltip]').tooltip();
      }

      // Initialize date pickers
      if ($.fn.datepicker) {
        $('.bme-date-picker').datepicker({
          dateFormat: 'yy-mm-dd',
        });
      }
    },

    /**
     * Initializes the live search for the database browser.
     */
    initDatabaseBrowser() {
      // CORRECTED: The ID generated by WP's search_box() is [base-id]-search-input
      const searchInput = $('#bme-listing-search-search-input');
      const filterForm = searchInput.closest('form');

      if (!searchInput.length || typeof $.fn.autocomplete === 'undefined') {
        return;
      }

      searchInput
        .autocomplete({
          source(request, response) {
            $.post(
              bmeAdmin.ajaxUrl,
              {
                action: 'bme_live_search',
                nonce: bmeAdmin.nonce,
                term: request.term,
              },
              function (res) {
                if (res.success) {
                  response(res.data);
                } else {
                  response([]);
                }
              }
            );
          },
          minLength: 3,
          select(event, ui) {
            event.preventDefault();
            // Set the search box value to the raw value (e.g., MLS# or Address)
            searchInput.val(ui.item.value);
            // Submit the form to apply the filter
            filterForm.submit();
          },
          focus(event, ui) {
            // When focusing on an item, show its raw value in the box
            event.preventDefault();
            searchInput.val(ui.item.value);
          },
        })
        .autocomplete('instance')._renderItem = function (ul, item) {
        // Custom display for each suggestion item
        return $('<li>')
          .append('<div>' + item.label + '</div>')
          .appendTo(ul);
      };
    },

    /**
     * Auto-expand advanced filters if any have values
     */
    checkAdvancedFiltersValues() {
      const advancedFilterFields = [
        '#filter_listing_id',
        '#filter_price_min',
        '#filter_price_max',
        '#filter_bedrooms_min',
        '#filter_bathrooms_min',
        '#filter_days_on_market_max',
        '#filter_year_built_min',
        '#filter_year_built_max'
      ];

      let hasValue = false;
      advancedFilterFields.forEach(function(fieldId) {
        const $field = $(fieldId);
        if ($field.length && $field.val() && $field.val() !== '') {
          hasValue = true;
        }
      });

      // If any advanced filter has a value, show the advanced filters panel
      if (hasValue) {
        const $panel = $('.bme-advanced-filters');
        const $button = $('.bme-toggle-advanced-filters');
        const $icon = $button.find('.dashicons');

        $panel.show();
        $icon.removeClass('dashicons-arrow-down-alt2').addClass('dashicons-arrow-up-alt2');
      }
    },

    /**
     * Load asynchronous statistics
     */
    loadAsyncStats() {
      $('.bme-loading[data-extraction-id]').each(function () {
        const $element = $(this);
        const extractionId = $element.data('extraction-id');

        BME.loadExtractionStatsById(extractionId, function (stats) {
          if (stats && stats.total_listings !== undefined) {
            // Use .text() to prevent XSS when inserting dynamic data
            $element.text(BME.numberFormat(stats.total_listings));
            $element.removeClass('bme-loading');
          }
        });
      });
    },

    /**
     * Setup real-time updates for running extractions (e.g., for list table, and now live progress)
     */
    setupRealTimeUpdates() {
      // Check for running extractions every 30 seconds
      setInterval(function () {
        BME.checkRunningExtractions();
      }, 30000); // This is for the list table, not the live progress box
    },

    /**
     * Confirm clear data action
     * @param e
     */
    confirmClear(e) {
      if (!confirm(bmeAdmin.strings.confirmClear)) {
        e.preventDefault();
        return false;
      }
    },

    /**
     * Confirm resync action
     * @param e
     */
    confirmResync(e) {
      if (!confirm(bmeAdmin.strings.confirmResync)) {
        e.preventDefault();
        return false;
      }
    },

    /**
     * Handle filter changes
     */
    handleFilterChange() {
      const $form = $(this).closest('form');

      // Auto-submit if configured
      if ($form.data('auto-submit')) {
        $form.submit();
      }
    },

    /**
     * Toggle advanced filters
     * @param e
     */
    toggleAdvancedFilters(e) {
      e.preventDefault();

      const $button = $(this);
      const $panel = $('.bme-advanced-filters');
      const $icon = $button.find('.dashicons');

      $panel.slideToggle(300, function () {
        const isVisible = $panel.is(':visible');

        // Toggle button text and icon
        if (isVisible) {
          $icon.removeClass('dashicons-arrow-down-alt2').addClass('dashicons-arrow-up-alt2');
          $button.find('span:not(.dashicons)').text('Advanced Filters');
        } else {
          $icon.removeClass('dashicons-arrow-up-alt2').addClass('dashicons-arrow-down-alt2');
          $button.find('span:not(.dashicons)').text('Advanced Filters');
        }
      });
    },

    /**
     * Handle filter form submission
     * @param e
     */
    handleFilterSubmit(e) {
      const $form = $(this);
      const $submitBtn = $form.find('[type="submit"]');

      // Show loading state
      $submitBtn.prop('disabled', true).text(bmeAdmin.strings.loading);

      // Allow normal form submission
      // Loading state will be reset on page load
    },

    /**
     * Load extraction statistics
     * @param e
     */
    loadExtractionStats(e) {
      e.preventDefault();

      const $button = $(this);
      const extractionId = $button.data('extraction-id');

      BME.loadExtractionStatsById(extractionId, function (stats) {
        BME.displayStatsModal(stats);
      });
    },

    /**
     * Load extraction statistics by ID
     * @param extractionId
     * @param callback
     */
    loadExtractionStatsById(extractionId, callback) {
      $.post(
        bmeAdmin.ajaxUrl,
        {
          action: 'bme_get_extraction_stats',
          extraction_id: extractionId,
          nonce: bmeAdmin.nonce,
        },
        function (response) {
          if (response.success) {
            callback(response.data);
          } else {
            console.error('Failed to load stats:', response.data);
            BME.showNotification(bmeAdmin.strings.error, 'error');
          }
        }
      ).fail(function () {
        console.error('AJAX request failed');
        BME.showNotification(bmeAdmin.strings.error, 'error');
      });
    },

    /**
     * Display statistics modal
     * @param stats
     */
    displayStatsModal(stats) {
      // Create modal HTML
      const modalHtml = BME.buildStatsModalHtml(stats);

      // Show modal (using WordPress admin styles)
      const $modal = $(modalHtml).appendTo('body');
      $modal.show();

      // Bind close events
      $modal.on('click', '.bme-modal-close, .bme-modal-overlay', function () {
        $modal.fadeOut(function () {
          $modal.remove();
        });
      });

      // Prevent modal content clicks from closing
      $modal.on('click', '.bme-modal-content', function (e) {
        e.stopPropagation();
      });
    },

    /**
     * Build statistics modal HTML
     * Note: For security, ensure all dynamic content is properly escaped.
     * For numeric values, BME.numberFormat already handles them.
     * For string values like dates, BME.formatDate is used.
     * If any raw string data from the API were to be displayed, it should be escaped.
     * @param stats
     */
    buildStatsModalHtml(stats) {
      // Helper to safely escape HTML for string values
      const escapeHtml = (text) => {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;',
        };
        return text.replace(/[&<>"']/g, function (m) {
          return map[m];
        });
      };

      return `
                <div class="bme-modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100000; display: flex; align-items: center; justify-content: center;">
                    <div class="bme-modal-content" style="background: white; padding: 20px; border-radius: 4px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div class="bme-modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
                            <h2 style="margin: 0;">Extraction Statistics</h2>
                            <button class="bme-modal-close" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
                        </div>
                        <div class="bme-modal-body">
                            <div class="bme-stats-grid">
                                <div class="bme-stat-item">
                                    <div class="bme-stat-value">${BME.numberFormat(stats.total_listings || 0)}</div>
                                    <div class="bme-stat-label">Total Listings</div>
                                </div>
                                <div class="bme-stat-item">
                                    <div class="bme-stat-value">${BME.numberFormat(stats.unique_statuses || 0)}</div>
                                    <div class="bme-stat-label">Unique Statuses</div>
                                </div>
                                <div class="bme-stat-item">
                                    <div class="bme-stat-value">$${BME.numberFormat(stats.avg_price || 0)}</div>
                                    <div class="bme-stat-label">Average Price</div>
                                </div>
                                <div class="bme-stat-item">
                                    <div class="bme-stat-value">$${BME.numberFormat(stats.min_price || 0)}</div>
                                    <div class="bme-stat-label">Min Price</div>
                                </div>
                                <div class="bme-stat-item">
                                    <div class="bme-stat-value">$${BME.numberFormat(stats.max_price || 0)}</div>
                                    <div class="bme-stat-label">Max Price</div>
                                </div>
                            </div>
                            ${
                              stats.oldest_listing
                                ? `
                                <p><strong>Oldest Listing:</strong> ${escapeHtml(BME.formatDate(stats.oldest_listing))}</p>
                            `
                                : ''
                            }
                            ${
                              stats.newest_update
                                ? `
                                <p><strong>Latest Update:</strong> ${escapeHtml(BME.formatDate(stats.newest_update))}</p>
                            `
                                : ''
                            }
                        </div>
                    </div>
                </div>
            `;
    },

    /**
     * Check for running extractions (for list table)
     */
    checkRunningExtractions() {
      // This would typically check for extraction status updates
      // For now, we'll just update timestamps
      $('.bme-last-run small').each(function () {
        const $element = $(this);
        const text = $element.text();

        // Update relative timestamps
        if (text.includes('ago')) {
          // Would need server data to properly update this
          // For a true real-time update, an AJAX call to get fresh data
          // for each relevant extraction would be needed here.
          // Example: BME.loadExtractionStatsById(extractionId, function(stats) { /* update UI */ });
        }
      });
    },

    /**
     * New: Initialize Live Progress Display
     */
    initLiveProgressDisplay() {
      const $container = $('#bme-live-progress-container');
      if (!$container.length) return;

      BME.currentExtractionId = $container.data('extraction-id');
      const initialState = window.bmeLiveProgressInitialState;

      if (initialState && initialState.status === 'running') {
        BME.startLiveProgressPolling(initialState);
      } else {
        $('#bme-live-progress-content').hide();
        $('#bme-live-progress-not-running').show();
      }
    },

    /**
     * New: Handle click on Run/Resync buttons to start polling
     * @param e
     */
    handleRunButtonClick(e) {
      const $button = $(this);
      const extractionId = $button.data('extraction-id');

      // Only start polling if we're on the edit screen for this extraction
      if (BME.currentExtractionId && BME.currentExtractionId == extractionId) {
        // Show the live progress section immediately
        $('#bme-live-progress-not-running').hide();
        $('#bme-live-progress-content').show();
        $('#bme-live-status').text('Starting...');
        $('#bme-live-processed').text('0');
        $('#bme-live-current-listing').text('N/A');
        $('#bme-live-last-updated').text('N/A');
        $('#bme-live-duration').text('0s');
        $('#bme-live-property-types').html('');
        $('#bme-live-message').text('Request sent to start extraction...');
        $('#bme-live-error-message').text('');

        // Start polling after a short delay to allow server to initialize
        setTimeout(() => {
          BME.startLiveProgressPolling();
        }, 1000);
      }
    },

    /**
     * New: Start polling for live extraction progress.
     * @param {Object} [initialState] Optional initial state to render immediately.
     */
    startLiveProgressPolling(initialState = null) {
      if (!BME.currentExtractionId) return;

      if (BME.liveProgressInterval) {
        clearInterval(BME.liveProgressInterval);
      }

      if (initialState) {
        BME.updateLiveProgressDisplay(initialState);
      }

      BME.liveProgressInterval = setInterval(() => {
        BME.fetchLiveProgress();
      }, 5000); // Poll every 5 seconds
    },

    /**
     * New: Fetch live progress via AJAX.
     */
    fetchLiveProgress() {
      $.post(
        bmeAdmin.ajaxUrl,
        {
          action: 'bme_get_live_extraction_progress',
          extraction_id: BME.currentExtractionId,
          nonce: bmeAdmin.nonce,
        },
        function (response) {
          if (response.success && response.data) {
            BME.updateLiveProgressDisplay(response.data);
            if (response.data.status !== 'running') {
              clearInterval(BME.liveProgressInterval);
              BME.liveProgressInterval = null;
              // Reload the page after a short delay to show final stats and clear transient
              setTimeout(() => {
                window.location.reload();
              }, 2000);
            }
          } else {
            // If no data or error, assume not running or finished
            clearInterval(BME.liveProgressInterval);
            BME.liveProgressInterval = null;
            $('#bme-live-progress-content').hide();
            $('#bme-live-progress-not-running').show();
          }
        }
      ).fail(function () {
        console.error('AJAX request for live progress failed.');
        clearInterval(BME.liveProgressInterval);
        BME.liveProgressInterval = null;
        $('#bme-live-progress-content').hide();
        $('#bme-live-progress-not-running').show();
      });
    },

    /**
     * New: Update the live progress display in the meta box.
     * @param {Object} data The live progress data.
     */
    updateLiveProgressDisplay(data) {
      $('#bme-live-progress-content').show();
      $('#bme-live-progress-not-running').hide();

      $('#bme-live-status').text(data.status || 'Unknown');
      $('#bme-live-processed').text(BME.numberFormat(data.total_processed_current_run || 0));
      $('#bme-live-current-listing').text(
        data.current_listing_mls_id
          ? `${data.current_listing_mls_id} (${data.current_listing_address || 'N/A'})`
          : 'N/A'
      );
      $('#bme-live-last-updated').text(
        data.last_update_timestamp ? BME.formatTimeAgo(data.last_update_timestamp) : 'N/A'
      );

      if (data.extraction_start_time && data.status === 'running') {
        const elapsedSeconds =
          Math.floor(Date.now() / 1000) - Math.floor(data.extraction_start_time);
        $('#bme-live-duration').text(BME.formatDuration(elapsedSeconds));
      } else if (data.extraction_start_time && data.status !== 'running') {
        // If finished, calculate total duration from start to last update or current time
        const actualEndTime = data.last_update_timestamp || Date.now() / 1000;
        const finalDuration = Math.floor(actualEndTime) - Math.floor(data.extraction_start_time);
        $('#bme-live-duration').text(BME.formatDuration(finalDuration));
      } else {
        $('#bme-live-duration').text('N/A');
      }

      $('#bme-live-message').text(data.last_message || '');
      $('#bme-live-error-message').text(data.error_message || '');

      // Display Property SubType counts
      const escapeHtml = (text) => {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;',
        };
        return text.replace(/[&<>"']/g, function (m) {
          return map[m];
        });
      };
      const propertyTypesHtml = Object.entries(data.property_subtype_counts || {})
        .map(([type, count]) => `${escapeHtml(type)}: ${BME.numberFormat(count)}`)
        .join(', ');
      $('#bme-live-property-types').html(propertyTypesHtml || 'N/A');
    },

    /**
     * Search listings with AJAX
     * @param filters
     * @param page
     */
    searchListings(filters, page) {
      return $.post(bmeAdmin.ajaxUrl, {
        action: 'bme_search_listings',
        filters,
        page: page || 1,
        nonce: bmeAdmin.nonce,
      });
    },

    /**
     * Get filter values with AJAX
     * @param field
     */
    getFilterValues(field) {
      return $.post(bmeAdmin.ajaxUrl, {
        action: 'bme_get_filter_values',
        field,
        nonce: bmeAdmin.nonce,
      });
    },

    /**
     * Utility function to format numbers
     * @param number
     */
    numberFormat(number) {
      return new Intl.NumberFormat().format(number);
    },

    /**
     * Utility function to format dates
     * @param dateString
     */
    formatDate(dateString) {
      const date = new Date(dateString);
      // Ensure date is valid before formatting
      if (isNaN(date.getTime())) {
        return 'Invalid Date';
      }
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    },

    /**
     * New: Utility function to format time ago (for last updated)
     * @param timestamp
     */
    formatTimeAgo(timestamp) {
      const seconds = Math.floor(Date.now() / 1000) - timestamp;
      if (seconds < 60) return `${seconds}s ago`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      return `${days}d ago`;
    },

    /**
     * New: Utility function to format duration (seconds to HH:MM:SS)
     * @param totalSeconds
     */
    formatDuration(totalSeconds) {
      const hours = Math.floor(totalSeconds / 3600);
      totalSeconds %= 3600;
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;

      const pad = (num) => num.toString().padStart(2, '0');

      if (hours > 0) {
        return `${hours}h ${pad(minutes)}m ${pad(seconds)}s`;
      } else if (minutes > 0) {
        return `${minutes}m ${pad(seconds)}s`;
      }
      return `${seconds}s`;
    },

    /**
     * Show notification
     * @param message
     * @param type
     */
    showNotification(message, type) {
      type = type || 'info';

      const $notice = $(`
                <div class="notice notice-${type} is-dismissible bme-notice">
                    <p>${message}</p>
                </div>
            `);

      $('.wrap h1').after($notice);

      // Auto-dismiss after 5 seconds
      setTimeout(function () {
        $notice.fadeOut(function () {
          $notice.remove();
        });
      }, 5000);
    },

    /**
     * Show loading overlay
     * @param $element
     */
    showLoading($element) {
      $element.addClass('bme-loading-overlay');
    },

    /**
     * Hide loading overlay
     * @param $element
     */
    hideLoading($element) {
      $element.removeClass('bme-loading-overlay');
    },

    /**
     * Debounce function for search inputs
     * @param func
     * @param wait
     */
    debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = function () {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    },

    /**
     * Initialize Chart.js charts for performance dashboard
     */
    initCharts() {
      // Only initialize if we're on the performance page
      if (!document.getElementById('bme-performance-canvas')) {
        return;
      }

      // Check if Chart.js is available, with retry mechanism
      const checkChartJs = function (attempts) {
        if (typeof Chart !== 'undefined') {
          // Ensure chart data is available before rendering
          if (typeof bmeChartData !== 'undefined' || typeof window.bmeChartData !== 'undefined') {
            console.log('BME: Chart.js and chart data both available');
            BME.renderPerformanceCharts();
          } else {
            console.log('BME: Chart.js loaded but chart data not available yet');
            // Try to render with empty/fallback data
            BME.renderPerformanceCharts();
          }
        } else if (attempts > 0) {
          setTimeout(function () {
            checkChartJs(attempts - 1);
          }, 200);
        } else {
          console.warn('BME: Chart.js failed to load after multiple attempts');
          BME.showChartError();
        }
      };

      // Start checking with 10 attempts (2 second total wait time)
      checkChartJs(10);
    },

    /**
     * Show error message when Chart.js fails to load
     */
    showChartError() {
      const performanceCtx = document.getElementById('bme-performance-canvas');
      const apiCtx = document.getElementById('bme-api-usage-canvas');

      const errorMessage =
        '<div style="text-align: center; padding: 40px; color: #d63638; border: 1px solid #d63638; background: #fcf2f2; border-radius: 4px;">' +
        '<strong>Chart Loading Error</strong><br>' +
        'Unable to load Chart.js library or chart data. Please check your internet connection or try refreshing the page.' +
        '</div>';

      if (performanceCtx && performanceCtx.parentElement) {
        performanceCtx.parentElement.innerHTML = errorMessage;
        console.error('BME: Replaced performance chart canvas with error message');
      }
      if (apiCtx && apiCtx.parentElement) {
        apiCtx.parentElement.innerHTML = errorMessage;
        console.error('BME: Replaced API usage chart canvas with error message');
      }
    },

    /**
     * Store chart instances for cleanup
     */
    chartInstances: {},

    /**
     * Render performance dashboard charts
     */
    renderPerformanceCharts() {
      try {
        // Prevent duplicate initialization
        if (this.chartsInitialized) {
          console.log('BME: Charts already initialized, skipping');
          return;
        }

        // Check if chartData is available (should be set by PHP via wp_localize_script)
        let chartData = null;
        if (typeof bmeChartData !== 'undefined') {
          chartData = bmeChartData;
          console.log('BME: Chart data found via bmeChartData:', chartData);
        } else if (typeof window.bmeChartData !== 'undefined') {
          chartData = window.bmeChartData;
          console.log('BME: Chart data found via window.bmeChartData:', chartData);
        } else {
          console.log('BME: Chart data not available, using fallback empty data');
          // Create fallback empty data structure
          chartData = {
            performance: {
              labels: [],
              datasets: [
                {
                  label: 'Listings Imported',
                  data: [],
                  borderColor: 'rgb(34, 197, 94)',
                  backgroundColor: 'rgba(34, 197, 94, 0.2)',
                  tension: 0.1,
                },
                {
                  label: 'Listings Updated',
                  data: [],
                  borderColor: 'rgb(59, 130, 246)',
                  backgroundColor: 'rgba(59, 130, 246, 0.2)',
                  tension: 0.1,
                },
              ],
            },
            api_usage: {
              labels: [],
              datasets: [
                {
                  label: 'API Requests',
                  data: [],
                  borderColor: 'rgb(168, 85, 247)',
                  backgroundColor: 'rgba(168, 85, 247, 0.2)',
                  yAxisID: 'y',
                  tension: 0.1,
                },
                {
                  label: 'Response Time (ms)',
                  data: [],
                  borderColor: 'rgb(245, 158, 11)',
                  backgroundColor: 'rgba(245, 158, 11, 0.2)',
                  yAxisID: 'y1',
                  tension: 0.1,
                },
              ],
            },
          };
        }

        // Clean up existing charts first
        this.destroyExistingCharts();

        // Initialize extraction performance chart
        const performanceCtx = document.getElementById('bme-performance-canvas');
        if (performanceCtx && chartData && chartData.performance) {
          try {
            this.chartInstances.performance = new Chart(performanceCtx, {
              type: 'line',
              data: chartData.performance,
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  title: {
                    display: true,
                    text: 'Extraction Performance Trends',
                  },
                  legend: {
                    display: true,
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: 'Listings Processed',
                    },
                  },
                },
              },
            });
            console.log('BME: Performance chart created successfully');
          } catch (error) {
            console.error('BME: Error creating performance chart:', error);
            this.showChartError();
          }
        } else {
          console.log('BME: Performance chart not created - missing canvas or data');
        }

        // Initialize API usage chart
        const apiCtx = document.getElementById('bme-api-usage-canvas');
        if (apiCtx && chartData && chartData.api_usage) {
          try {
            this.chartInstances.apiUsage = new Chart(apiCtx, {
              type: 'line',
              data: chartData.api_usage,
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                  mode: 'index',
                  intersect: false,
                },
                plugins: {
                  title: {
                    display: true,
                    text: 'API Usage Patterns',
                  },
                  legend: {
                    display: true,
                  },
                },
                scales: {
                  y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: 'API Requests',
                    },
                  },
                  y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: 'Response Time (ms)',
                    },
                    grid: {
                      drawOnChartArea: false,
                    },
                  },
                },
              },
            });
            console.log('BME: API usage chart created successfully');
          } catch (error) {
            console.error('BME: Error creating API usage chart:', error);
            this.showChartError();
          }
        } else {
          console.log('BME: API usage chart not created - missing canvas or data');
        }

        // Mark charts as initialized
        this.chartsInitialized = true;
        console.log('BME: Charts successfully initialized');
      } catch (error) {
        console.error('BME: Error rendering performance charts:', error);
        BME.showChartError();
      }
    },

    /**
     * Destroy existing chart instances before creating new ones
     */
    destroyExistingCharts() {
      try {
        if (this.chartInstances.performance) {
          this.chartInstances.performance.destroy();
          console.log('BME: Destroyed existing performance chart');
        }
        if (this.chartInstances.apiUsage) {
          this.chartInstances.apiUsage.destroy();
          console.log('BME: Destroyed existing API usage chart');
        }
        this.chartInstances = {};
        this.chartsInitialized = false;
      } catch (error) {
        console.warn('BME: Error destroying existing charts:', error);
        this.chartInstances = {};
        this.chartsInitialized = false;
      }
    },

    /**
     * Initialize Market Analytics Filter Interface
     */
    initMarketAnalyticsFilters() {
      // Only initialize if we're on the market analytics page
      if (!document.getElementById('bme-market-filter-form')) {
        return;
      }

      this.bindFilterEvents();
      this.setupCascadingFilters();
      this.initFilterToggle();
    },

    /**
     * Bind filter-specific event handlers
     */
    bindFilterEvents() {
      // Filter toggle functionality
      $(document).on('click', '#bme-toggle-filters', this.toggleFilters.bind(this));

      // Cascading filter changes
      $(document).on('change', '[data-filter-field]', this.handleCascadingFilter.bind(this));

      // Real-time filter updates
      $(document).on('input', '.bme-filter-field input', this.debounceFilterUpdate.bind(this));

      // Clear individual filter sections
      $(document).on('click', '.bme-clear-section', this.clearFilterSection.bind(this));
    },

    /**
     * Initialize filter toggle functionality
     */
    initFilterToggle() {
      const filterForm = document.querySelector('.bme-filter-form');
      const toggleButton = document.getElementById('bme-toggle-filters');

      if (!filterForm || !toggleButton) return;

      // Check if there are active filters to determine initial state
      const hasActiveFilters = this.hasActiveFilters();
      if (!hasActiveFilters) {
        filterForm.classList.add('collapsed');
        toggleButton.innerHTML = '<span class="dashicons dashicons-filter"></span> Show Filters';
      }
    },

    /**
     * Toggle filter visibility
     * @param e
     */
    toggleFilters(e) {
      e.preventDefault();
      const filterForm = document.querySelector('.bme-filter-form');
      const toggleButton = e.currentTarget;

      if (filterForm.classList.contains('collapsed')) {
        filterForm.classList.remove('collapsed');
        toggleButton.innerHTML = '<span class="dashicons dashicons-filter"></span> Hide Filters';
      } else {
        filterForm.classList.add('collapsed');
        toggleButton.innerHTML = '<span class="dashicons dashicons-filter"></span> Show Filters';
      }
    },

    /**
     * Check if there are active filters
     */
    hasActiveFilters() {
      const form = document.getElementById('bme-market-filter-form');
      if (!form) return false;

      const formData = new FormData(form);
      for (const [key, value] of formData.entries()) {
        if (key !== 'page' && key !== 'period_days' && value && value.trim() !== '') {
          return true;
        }
      }
      return false;
    },

    /**
     * Setup cascading filter dependencies
     */
    setupCascadingFilters() {
      // City -> Subdivision dependency
      this.setupFilterDependency('city', 'subdivision');
      // Property Type -> Property Sub Type dependency
      this.setupFilterDependency('property_type', 'property_sub_type');
    },

    /**
     * Setup dependency between two filter fields
     * @param parentField
     * @param childField
     */
    setupFilterDependency(parentField, childField) {
      const parentSelect = document.getElementById('bme-filter-' + parentField.replace('_', '-'));
      const childSelect = document.getElementById('bme-filter-' + childField.replace('_', '-'));

      if (!parentSelect || !childSelect) return;

      $(parentSelect).on('change', () => {
        this.updateDependentFilter(parentField, childField);
      });
    },

    /**
     * Handle cascading filter changes
     * @param e
     */
    handleCascadingFilter(e) {
      const fieldName = e.target.dataset.filterField;
      const dependentFields = this.getFilterDependents(fieldName);

      dependentFields.forEach((dependent) => {
        this.updateDependentFilter(fieldName, dependent);
      });
    },

    /**
     * Get dependent fields for a given filter field
     * @param fieldName
     */
    getFilterDependents(fieldName) {
      const dependencies = {
        city: ['subdivision'],
        property_type: ['property_sub_type'],
      };

      return dependencies[fieldName] || [];
    },

    /**
     * Update dependent filter options via AJAX
     * @param parentField
     * @param childField
     */
    updateDependentFilter(parentField, childField) {
      const parentElement = document.getElementById('bme-filter-' + parentField.replace('_', '-'));
      const childElement = document.getElementById('bme-filter-' + childField.replace('_', '-'));

      if (!parentElement || !childElement) return;

      // Get current form values for context
      const formData = this.getFilterFormData();

      // Show loading state
      childElement.classList.add('bme-filter-loading');
      childElement.disabled = true;

      $.ajax({
        url: ajaxurl,
        type: 'POST',
        data: {
          action: 'bme_get_filter_values',
          field: childField,
          parent_filters: formData,
          nonce: bmeAdmin.nonce || '',
        },
        success: (response) => {
          if (response.success && response.data) {
            this.populateFilterOptions(childElement, response.data);
          }
        },
        error: (xhr, status, error) => {
          console.error('BME: Error updating dependent filter:', error);
        },
        complete: () => {
          childElement.classList.remove('bme-filter-loading');
          childElement.disabled = false;
        },
      });
    },

    /**
     * Get current form data as object
     */
    getFilterFormData() {
      const form = document.getElementById('bme-market-filter-form');
      if (!form) return {};

      const formData = new FormData(form);
      const data = {};

      for (const [key, value] of formData.entries()) {
        if (data[key]) {
          if (!Array.isArray(data[key])) {
            data[key] = [data[key]];
          }
          data[key].push(value);
        } else {
          data[key] = value;
        }
      }

      return data;
    },

    /**
     * Populate filter select options
     * @param selectElement
     * @param options
     */
    populateFilterOptions(selectElement, options) {
      // Clear existing options except the first default one
      const firstOption = selectElement.options[0];
      selectElement.innerHTML = '';
      if (firstOption) {
        selectElement.appendChild(firstOption);
      }

      // Add new options
      options.forEach((option) => {
        const optionElement = document.createElement('option');
        optionElement.value = option.value;
        optionElement.textContent = option.label;
        selectElement.appendChild(optionElement);
      });
    },

    /**
     * Debounced filter update for input fields
     * @param e
     */
    debounceFilterUpdate(e) {
      clearTimeout(this.filterUpdateTimeout);
      this.filterUpdateTimeout = setTimeout(() => {
        this.handleLiveFilterUpdate(e);
      }, 500); // 500ms delay
    },

    /**
     * Handle live filter updates (for range inputs)
     * @param e
     */
    handleLiveFilterUpdate(e) {
      const input = e.target;
      const section = input.closest('.bme-filter-section');

      // Update result count preview
      this.updateResultsPreview();

      // Add visual feedback
      section.classList.add('bme-filter-updated');
      setTimeout(() => {
        section.classList.remove('bme-filter-updated');
      }, 1000);
    },

    /**
     * Update results preview count
     */
    updateResultsPreview() {
      const formData = this.getFilterFormData();

      $.ajax({
        url: ajaxurl,
        type: 'POST',
        data: {
          action: 'bme_get_filter_preview',
          filters: formData,
          nonce: bmeAdmin.nonce || '',
        },
        success: (response) => {
          if (response.success && response.data) {
            this.updateResultsCount(response.data.count);
          }
        },
        error: (xhr, status, error) => {
          console.error('BME: Error getting results preview:', error);
        },
      });
    },

    /**
     * Update results count display
     * @param count
     */
    updateResultsCount(count) {
      const countElement = document.querySelector('.bme-results-count');
      if (countElement) {
        countElement.textContent = `Preview: ${count.toLocaleString()} listings`;
        countElement.classList.add('bme-count-updated');
        setTimeout(() => {
          countElement.classList.remove('bme-count-updated');
        }, 1000);
      }
    },

    /**
     * Clear a filter section
     * @param e
     */
    clearFilterSection(e) {
      e.preventDefault();
      const section = e.target.closest('.bme-filter-section');
      const inputs = section.querySelectorAll('input, select');

      inputs.forEach((input) => {
        if (input.type === 'checkbox') {
          input.checked = false;
        } else if (input.tagName === 'SELECT') {
          input.selectedIndex = 0;
        } else {
          input.value = '';
        }
      });

      // Trigger change events for cascading filters
      inputs.forEach((input) => {
        $(input).trigger('change');
      });
    },

    /**
     * Initialize Market Analytics Charts
     */
    initMarketAnalyticsCharts() {
      // Only initialize if we're on the market analytics page and have chart data
      if (
        !document.getElementById('priceTrendsChart') ||
        typeof window.bmeMarketData === 'undefined'
      ) {
        console.log('BME Market Analytics: Chart elements or data not available');
        return;
      }

      console.log('BME Market Analytics: Initializing charts with data:', window.bmeMarketData);

      try {
        this.initPriceTrendsChart();
        this.initDOMDistributionChart();
        this.initInventoryStatusChart();
        this.initAbsorptionRateChart();
        console.log('BME Market Analytics: All charts initialized successfully');
      } catch (error) {
        console.error('BME Market Analytics: Error initializing charts:', error);
      }
    },

    /**
     * Price Trends Chart
     */
    initPriceTrendsChart() {
      const ctx = document.getElementById('priceTrendsChart');
      if (!ctx || !window.bmeMarketData.priceTrends) return;

      if (this.chartInstances.priceTrends) {
        this.chartInstances.priceTrends.destroy();
      }

      this.chartInstances.priceTrends = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: window.bmeMarketData.priceTrends,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Average List Price Trends',
            },
            legend: {
              display: true,
              position: 'top',
            },
          },
          scales: {
            y: {
              beginAtZero: false,
              ticks: {
                callback(value) {
                  return '$' + value.toLocaleString();
                },
              },
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              grid: {
                drawOnChartArea: false,
              },
              ticks: {
                beginAtZero: true,
              },
            },
          },
          interaction: {
            mode: 'index',
            intersect: false,
          },
        },
      });
    },

    /**
     * Days on Market Distribution Chart
     */
    initDOMDistributionChart() {
      const ctx = document.getElementById('domDistributionChart');
      if (!ctx || !window.bmeMarketData.domAnalysis) return;

      if (this.chartInstances.domDistribution) {
        this.chartInstances.domDistribution.destroy();
      }

      const domData = window.bmeMarketData.domAnalysis;

      this.chartInstances.domDistribution = new Chart(ctx.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: ['Fast Sales (â‰¤7 days)', 'Normal Sales (8-45 days)', 'Slow Sales (>45 days)'],
          datasets: [
            {
              label: 'Sales Distribution',
              data: [domData.fast_sales, domData.normal_sales, domData.slow_sales],
              backgroundColor: [
                'rgba(34, 197, 94, 0.8)', // Green for fast
                'rgba(59, 130, 246, 0.8)', // Blue for normal
                'rgba(239, 68, 68, 0.8)', // Red for slow
              ],
              borderColor: [
                'rgba(34, 197, 94, 1)',
                'rgba(59, 130, 246, 1)',
                'rgba(239, 68, 68, 1)',
              ],
              borderWidth: 2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Sales Speed Distribution',
            },
            legend: {
              position: 'bottom',
            },
          },
        },
      });
    },

    /**
     * Inventory Status Chart
     */
    initInventoryStatusChart() {
      const ctx = document.getElementById('inventoryStatusChart');
      if (!ctx || !window.bmeMarketData.inventoryAnalysis) return;

      if (this.chartInstances.inventoryStatus) {
        this.chartInstances.inventoryStatus.destroy();
      }

      const inventoryData = window.bmeMarketData.inventoryAnalysis.current_inventory || [];

      // Handle empty data case
      if (!Array.isArray(inventoryData) || inventoryData.length === 0) {
        const noDataMessage = document.createElement('div');
        noDataMessage.className = 'chart-no-data';
        noDataMessage.textContent = 'No inventory data available';
        ctx.parentNode.replaceChild(noDataMessage, ctx);
        return;
      }

      const labels = inventoryData.map((item) => item.standard_status || 'Unknown');
      const counts = inventoryData.map((item) => parseInt(item.count || 0));
      const colors = [
        'rgba(34, 197, 94, 0.8)', // Active - Green
        'rgba(59, 130, 246, 0.8)', // Under Contract - Blue
        'rgba(245, 158, 11, 0.8)', // Pending - Amber
        'rgba(168, 85, 247, 0.8)', // Other statuses - Purple
        'rgba(236, 72, 153, 0.8)', // Additional colors
      ];

      this.chartInstances.inventoryStatus = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Active Listings',
              data: counts,
              backgroundColor: colors.slice(0, labels.length),
              borderColor: colors.slice(0, labels.length).map((color) => color.replace('0.8', '1')),
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Current Inventory by Status',
            },
            legend: {
              display: false,
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
              },
            },
          },
        },
      });
    },

    /**
     * Market Absorption Rate Chart
     */
    initAbsorptionRateChart() {
      const ctx = document.getElementById('absorptionRateChart');
      if (!ctx || !window.bmeMarketData.inventoryAnalysis) return;

      if (this.chartInstances.absorptionRate) {
        this.chartInstances.absorptionRate.destroy();
      }

      const absorptionData = window.bmeMarketData.inventoryAnalysis.absorption_rate;
      if (!absorptionData || absorptionData.length === 0) {
        // Show placeholder if no data
        ctx.getContext('2d').fillText('No absorption data available', 10, 50);
        return;
      }

      const labels = absorptionData.map((item) => {
        const date = new Date(item.month + '-01');
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
      });
      const counts = absorptionData.map((item) => parseInt(item.closed_count));

      this.chartInstances.absorptionRate = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Monthly Closed Sales',
              data: counts,
              borderColor: 'rgba(34, 197, 94, 1)',
              backgroundColor: 'rgba(34, 197, 94, 0.1)',
              tension: 0.4,
              fill: true,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Monthly Sales Volume (Last 6 Months)',
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
              },
            },
          },
        },
      });
    },

    /**
     * Handle view details button click
     */
    handleViewDetails(e) {
      console.log('BME: handleViewDetails called', e);
      e.preventDefault();
      e.stopPropagation();
      const listingId = $(e.currentTarget).data('listing-id');
      console.log('BME: Listing ID:', listingId);
      this.loadPropertyDetails(listingId);
    },

    /**
     * Load property details via AJAX
     */
    loadPropertyDetails(listingId) {
      console.log('BME: loadPropertyDetails called with ID:', listingId);
      const self = this;

      // Show loading state
      console.log('BME: Showing loading modal');
      this.showPropertyModal('<div class="bme-property-loading"><div class="spinner is-active"></div><p>Loading property details...</p></div>');

      console.log('BME: Making AJAX request to:', bmeAdmin.ajaxUrl);
      console.log('BME: AJAX data:', {
        action: 'bme_get_listing_details',
        nonce: bmeAdmin.nonce,
        listing_id: listingId
      });

      $.ajax({
        url: bmeAdmin.ajaxUrl,
        type: 'POST',
        data: {
          action: 'bme_get_listing_details',
          nonce: bmeAdmin.nonce,
          listing_id: listingId
        },
        success(response) {
          console.log('BME: AJAX success response:', response);
          if (response.success && response.data) {
            console.log('BME: Rendering property details');
            self.renderPropertyDetails(response.data);
          } else {
            console.log('BME: AJAX returned error:', response);
            self.showPropertyModal('<div class="bme-property-error"><p>Error loading property details: ' + (response.data?.message || 'Unknown error') + '</p></div>');
          }
        },
        error(xhr, status, error) {
          console.error('BME: AJAX error:', {xhr, status, error});
          self.showPropertyModal('<div class="bme-property-error"><p>Error loading property details. Please try again.</p></div>');
        }
      });
    },

    /**
     * Show property modal
     */
    showPropertyModal(content) {
      let modal = $('#bme-property-modal');

      if (!modal.length) {
        $('body').append(`
          <div id="bme-property-modal" class="bme-modal">
            <div class="bme-modal-backdrop"></div>
            <div class="bme-modal-container">
              <button class="bme-modal-close" aria-label="Close">&times;</button>
              <div class="bme-modal-content"></div>
            </div>
          </div>
        `);
        modal = $('#bme-property-modal');
      }

      modal.find('.bme-modal-content').html(content);
      modal.addClass('active');
      $('body').addClass('bme-modal-open');
    },

    /**
     * Close property modal
     */
    closePropertyModal(e) {
      if (e && $(e.target).hasClass('bme-modal-container')) {
        return; // Don't close if clicking inside the content
      }

      $('#bme-property-modal').removeClass('active');
      $('body').removeClass('bme-modal-open');
    },

    /**
     * Open export modal and populate with current filters
     */
    openExportModal(e) {
      console.log('BME Export: openExportModal called');
      e.preventDefault();

      const $modal = $('#bme-export-modal');
      const $filterSummary = $('#bme-export-filter-summary');
      const $hiddenFilters = $('#bme-export-hidden-filters');

      console.log('BME Export: Modal element found:', $modal.length > 0);

      // Clear previous content
      $filterSummary.empty();
      $hiddenFilters.empty();

      const filters = [];

      // Collect all filter inputs from anywhere on the page (not just first form)
      $('[name^="filter_"], [name="s"]').each(function() {
        const $input = $(this);
        const name = $input.attr('name');
        let value = $input.val();

        // Skip empty values
        if (!value || value === '') {
          return;
        }

        // Add to summary
        let displayName = name.replace('filter_', '').replace(/_/g, ' ');
        displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);

        let displayValue = value;
        if ($input.is('select')) {
          displayValue = $input.find('option:selected').text();
          // Skip if it's just the placeholder/empty option
          if (!displayValue || displayValue.trim() === '') {
            return;
          }
        }

        console.log('BME Export: Found filter', name, '=', value, '(display:', displayValue + ')');

        filters.push({ name: displayName, value: displayValue });

        // Add hidden input to export form
        $hiddenFilters.append(
          $('<input>').attr({
            type: 'hidden',
            name: name,
            value: value
          })
        );
      });

      console.log('BME Export: Total filters found:', filters.length);

      // Display filter summary
      if (filters.length === 0) {
        $filterSummary.append('<li><em>No filters applied - exporting all listings</em></li>');
      } else {
        filters.forEach(filter => {
          $filterSummary.append(`<li><strong>${filter.name}:</strong> ${filter.value}</li>`);
        });
      }

      // Show modal
      $modal.fadeIn(300);
      $('body').addClass('bme-modal-open');
    },

    /**
     * Close export modal
     */
    closeExportModal(e) {
      if (e && $(e.target).hasClass('bme-modal-dialog')) {
        return; // Don't close if clicking inside the dialog
      }

      $('#bme-export-modal').fadeOut(300);
      $('body').removeClass('bme-modal-open');
    },

    /**
     * Render comprehensive property details
     */
    renderPropertyDetails(data) {
      const listing = data.listing;
      const photos = data.photos || [];
      const rooms = data.rooms || [];
      const openHouses = data.open_houses || [];
      const history = data.history || [];
      const virtualTours = data.virtual_tours || {};

      const formatCurrency = (value) => {
        if (!value || value == 0) return 'N/A';
        return '$' + parseFloat(value).toLocaleString();
      };

      const formatNumber = (value) => {
        if (!value || value == 0) return 'N/A';
        return parseFloat(value).toLocaleString();
      };

      const formatDate = (dateString) => {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString();
      };

      const formatTime = (timeString) => {
        if (!timeString) return 'N/A';
        const date = new Date(timeString);
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
      };

      const formatArray = (value) => {
        if (!value) return 'N/A';
        // If it's already a string that looks like JSON array
        if (typeof value === 'string') {
          try {
            const parsed = JSON.parse(value);
            if (Array.isArray(parsed)) {
              return parsed.join(', ');
            }
            return value;
          } catch (e) {
            // If it's just a regular string, return it
            return value;
          }
        }
        // If it's already an array
        if (Array.isArray(value)) {
          return value.join(', ');
        }
        return value;
      };

      // Build photo gallery
      let photoGallery = '';
      if (photos.length > 0) {
        photoGallery = `
          <div class="bme-property-photos">
            <div class="bme-photo-main">
              <img src="${photos[0].media_url}" alt="Property Photo" class="bme-main-photo">
              <div class="bme-photo-counter"><span class="current-photo">1</span> / ${photos.length}</div>
              ${photos.length > 1 ? `
                <button class="bme-photo-nav bme-photo-prev" aria-label="Previous photo">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                  </svg>
                </button>
                <button class="bme-photo-nav bme-photo-next" aria-label="Next photo">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                </button>
              ` : ''}
            </div>
            <div class="bme-photo-thumbnails">
              ${photos.map((photo, idx) => `
                <img src="${photo.media_url}" alt="Thumbnail ${idx + 1}" data-index="${idx}" class="bme-photo-thumb ${idx === 0 ? 'active' : ''}">
              `).join('')}
            </div>
          </div>
        `;
      } else {
        photoGallery = '<div class="bme-property-photos-placeholder">No photos available</div>';
      }

      // Build property details HTML (similar to Redfin/Zillow)
      const html = `
        <div class="bme-property-details">
          ${photoGallery}

          <!-- Header Section -->
          <div class="bme-property-header">
            <div class="bme-property-price">${formatCurrency(listing.list_price)}</div>
            <div class="bme-property-address">
              <h2>${listing.unparsed_address || 'Address not available'}</h2>
              <p>${listing.city || ''}, ${listing.state_or_province || ''} ${listing.postal_code || ''}</p>
            </div>
            <div class="bme-property-key-facts">
              <span class="bme-fact"><strong>${listing.bedrooms_total || 0}</strong> Beds</span>
              <span class="bme-fact"><strong>${listing.bathrooms_total_decimal || 0}</strong> Baths</span>
              <span class="bme-fact"><strong>${formatNumber(listing.living_area)}</strong> Sq Ft</span>
              <span class="bme-fact"><strong>${listing.property_type || 'N/A'}</strong></span>
            </div>
            <div class="bme-property-status">
              <span class="bme-status-badge status-${(listing.standard_status || '').toLowerCase().replace(/ /g, '-')}">${listing.standard_status || 'N/A'}</span>
              <span class="bme-mls-number">MLS# ${listing.listing_id}</span>
            </div>
          </div>

          <!-- Tabs Navigation -->
          <div class="bme-property-tabs">
            <button class="bme-tab active" data-tab="overview">Overview</button>
            <button class="bme-tab" data-tab="details">Details</button>
            <button class="bme-tab" data-tab="financial">Financial</button>
            <button class="bme-tab" data-tab="features">Features</button>
            ${rooms.length > 0 ? '<button class="bme-tab" data-tab="rooms">Rooms</button>' : ''}
            ${openHouses.length > 0 ? '<button class="bme-tab" data-tab="openhouses">Open Houses</button>' : ''}
            ${history.length > 0 ? '<button class="bme-tab" data-tab="history">History</button>' : ''}
          </div>

          <!-- Tab Content -->
          <div class="bme-property-tab-content">
            <!-- Overview Tab -->
            <div class="bme-tab-pane active" data-pane="overview">
              ${listing.public_remarks ? `
                <div class="bme-property-section">
                  <h3>Property Description</h3>
                  <p class="bme-property-description">${listing.public_remarks}</p>
                </div>
              ` : ''}

              ${(virtualTours.virtual_tour_link_1 || virtualTours.virtual_tour_link_2 || virtualTours.virtual_tour_link_3 || listing.virtual_tour_url_unbranded || listing.virtual_tour_url_branded) ? `
                <div class="bme-property-section">
                  <h3>Virtual Tours</h3>
                  <div class="bme-virtual-tours">
                    ${virtualTours.virtual_tour_link_1 ? `<p><a href="${virtualTours.virtual_tour_link_1}" target="_blank" class="bme-tour-link">ðŸ“¹ Virtual Tour 1</a></p>` : ''}
                    ${virtualTours.virtual_tour_link_2 ? `<p><a href="${virtualTours.virtual_tour_link_2}" target="_blank" class="bme-tour-link">ðŸ“¹ Virtual Tour 2</a></p>` : ''}
                    ${virtualTours.virtual_tour_link_3 ? `<p><a href="${virtualTours.virtual_tour_link_3}" target="_blank" class="bme-tour-link">ðŸ“¹ Virtual Tour 3</a></p>` : ''}
                    ${listing.virtual_tour_url_unbranded ? `<p><a href="${listing.virtual_tour_url_unbranded}" target="_blank" class="bme-tour-link">ðŸ“¹ Unbranded Tour</a></p>` : ''}
                    ${listing.virtual_tour_url_branded ? `<p><a href="${listing.virtual_tour_url_branded}" target="_blank" class="bme-tour-link">ðŸ“¹ Branded Tour</a></p>` : ''}
                  </div>
                </div>
              ` : ''}

              <div class="bme-property-section">
                <h3>Property Information</h3>
                <div class="bme-property-grid">
                  <div class="bme-grid-item"><label>Property Type:</label><span>${listing.property_type || 'N/A'}</span></div>
                  <div class="bme-grid-item"><label>Property Sub Type:</label><span>${listing.property_sub_type || 'N/A'}</span></div>
                  ${listing.business_type ? `<div class="bme-grid-item"><label>Business Type:</label><span>${listing.business_type}</span></div>` : ''}
                  <div class="bme-grid-item"><label>Year Built:</label><span>${listing.year_built || 'N/A'}</span></div>
                  ${listing.year_built_effective ? `<div class="bme-grid-item"><label>Effective Year Built:</label><span>${listing.year_built_effective}</span></div>` : ''}
                  <div class="bme-grid-item"><label>Lot Size:</label><span>${formatNumber(listing.lot_size_square_feet)} Sq Ft</span></div>
                  <div class="bme-grid-item"><label>Stories:</label><span>${listing.stories_total || 'N/A'}</span></div>
                  ${listing.levels ? `<div class="bme-grid-item"><label>Levels:</label><span>${listing.levels}</span></div>` : ''}
                  <div class="bme-grid-item"><label>Above Grade Finished Area:</label><span>${formatNumber(listing.above_grade_finished_area)} Sq Ft</span></div>
                  <div class="bme-grid-item"><label>Below Grade Finished Area:</label><span>${formatNumber(listing.below_grade_finished_area)} Sq Ft</span></div>
                  ${listing.building_area_total ? `<div class="bme-grid-item"><label>Total Building Area:</label><span>${formatNumber(listing.building_area_total)} Sq Ft</span></div>` : ''}
                  <div class="bme-grid-item"><label>Garage Spaces:</label><span>${listing.garage_spaces || 'N/A'}</span></div>
                  ${listing.attached_garage_yn ? `<div class="bme-grid-item"><label>Attached Garage:</label><span>${listing.attached_garage_yn === 'true' || listing.attached_garage_yn === 1 ? 'Yes' : 'No'}</span></div>` : ''}
                  ${listing.covered_spaces ? `<div class="bme-grid-item"><label>Covered Parking Spaces:</label><span>${listing.covered_spaces}</span></div>` : ''}
                  ${listing.property_attached_yn ? `<div class="bme-grid-item"><label>Attached Property:</label><span>${listing.property_attached_yn === 'true' || listing.property_attached_yn === 1 ? 'Yes' : 'No'}</span></div>` : ''}
                  ${listing.structure_type ? `<div class="bme-grid-item"><label>Structure Type:</label><span>${formatArray(listing.structure_type)}</span></div>` : ''}
                  ${listing.number_of_units_total ? `<div class="bme-grid-item"><label>Number of Units:</label><span>${listing.number_of_units_total}</span></div>` : ''}
                </div>
              </div>

              ${(listing.county_or_parish || listing.subdivision_name || listing.mls_area_major || listing.mls_area_minor || listing.building_name || listing.unit_number) ? `
                <div class="bme-property-section">
                  <h3>Location Details</h3>
                  <div class="bme-property-grid">
                    ${listing.county_or_parish ? `<div class="bme-grid-item"><label>County:</label><span>${listing.county_or_parish}</span></div>` : ''}
                    ${listing.subdivision_name ? `<div class="bme-grid-item"><label>Subdivision:</label><span>${listing.subdivision_name}</span></div>` : ''}
                    ${listing.building_name ? `<div class="bme-grid-item"><label>Building:</label><span>${listing.building_name}</span></div>` : ''}
                    ${listing.unit_number ? `<div class="bme-grid-item"><label>Unit Number:</label><span>${listing.unit_number}</span></div>` : ''}
                    ${listing.mls_area_major ? `<div class="bme-grid-item"><label>MLS Area (Major):</label><span>${listing.mls_area_major}</span></div>` : ''}
                    ${listing.mls_area_minor ? `<div class="bme-grid-item"><label>MLS Area (Minor):</label><span>${listing.mls_area_minor}</span></div>` : ''}
                  </div>
                </div>
              ` : ''}

              ${listing.agent_full_name ? `
                <div class="bme-property-section">
                  <h3>Listing Agent</h3>
                  <div class="bme-agent-info">
                    <p><strong>${listing.agent_full_name}</strong></p>
                    ${listing.agent_phone ? `<p>Phone: ${listing.agent_phone}</p>` : ''}
                    ${listing.agent_email ? `<p>Email: ${listing.agent_email}</p>` : ''}
                    ${listing.agent_mls_id ? `<p>Agent MLS ID: ${listing.agent_mls_id}</p>` : ''}
                  </div>
                </div>
              ` : ''}

              ${listing.office_name ? `
                <div class="bme-property-section">
                  <h3>Listing Office</h3>
                  <div class="bme-office-info">
                    <p><strong>${listing.office_name}</strong></p>
                    ${listing.office_phone ? `<p>Phone: ${listing.office_phone}</p>` : ''}
                  </div>
                </div>
              ` : ''}

              ${(listing.elementary_school || listing.middle_or_junior_school || listing.high_school || listing.school_district) ? `
                <div class="bme-property-section">
                  <h3>School Information</h3>
                  <div class="bme-property-grid">
                    ${listing.elementary_school ? `<div class="bme-grid-item"><label>Elementary School:</label><span>${listing.elementary_school}</span></div>` : ''}
                    ${listing.middle_or_junior_school ? `<div class="bme-grid-item"><label>Middle School:</label><span>${listing.middle_or_junior_school}</span></div>` : ''}
                    ${listing.high_school ? `<div class="bme-grid-item"><label>High School:</label><span>${listing.high_school}</span></div>` : ''}
                    ${listing.school_district ? `<div class="bme-grid-item"><label>School District:</label><span>${listing.school_district}</span></div>` : ''}
                  </div>
                </div>
              ` : ''}

              ${listing.showing_instructions ? `
                <div class="bme-property-section">
                  <h3>Showing Instructions</h3>
                  <p>${listing.showing_instructions}</p>
                </div>
              ` : ''}

              ${(listing.close_date || listing.listing_contract_date || listing.status_change_timestamp || listing.off_market_date || listing.possession || listing.contingency) ? `
                <div class="bme-property-section">
                  <h3>Important Dates & Terms</h3>
                  <div class="bme-property-grid">
                    ${listing.listing_contract_date ? `<div class="bme-grid-item"><label>Listing Date:</label><span>${formatDate(listing.listing_contract_date)}</span></div>` : ''}
                    ${listing.close_date ? `<div class="bme-grid-item"><label>Close Date:</label><span>${formatDate(listing.close_date)}</span></div>` : ''}
                    ${listing.status_change_timestamp ? `<div class="bme-grid-item"><label>Status Changed:</label><span>${formatDate(listing.status_change_timestamp)}</span></div>` : ''}
                    ${listing.off_market_date ? `<div class="bme-grid-item"><label>Off Market Date:</label><span>${formatDate(listing.off_market_date)}</span></div>` : ''}
                    ${listing.possession ? `<div class="bme-grid-item full-width"><label>Possession:</label><span>${listing.possession}</span></div>` : ''}
                    ${listing.contingency ? `<div class="bme-grid-item full-width"><label>Contingencies:</label><span>${formatArray(listing.contingency)}</span></div>` : ''}
                    ${listing.expiration_date ? `<div class="bme-grid-item"><label>Listing Expires:</label><span>${formatDate(listing.expiration_date)}</span></div>` : ''}
                  </div>
                </div>
              ` : ''}

              ${(listing.disclosures || listing.exclusions || listing.documents_available) ? `
                <div class="bme-property-section">
                  <h3>Legal & Disclosures</h3>
                  <div class="bme-property-grid">
                    ${listing.disclosures ? `<div class="bme-grid-item full-width"><label>Disclosures:</label><span>${listing.disclosures}</span></div>` : ''}
                    ${listing.exclusions ? `<div class="bme-grid-item full-width"><label>Exclusions:</label><span>${listing.exclusions}</span></div>` : ''}
                    ${listing.documents_available ? `<div class="bme-grid-item full-width"><label>Documents Available:</label><span>${formatArray(listing.documents_available)}</span></div>` : ''}
                    ${listing.documents_count ? `<div class="bme-grid-item"><label>Number of Documents:</label><span>${listing.documents_count}</span></div>` : ''}
                    ${listing.special_licenses ? `<div class="bme-grid-item full-width"><label>Special Licenses Required:</label><span>${listing.special_licenses}</span></div>` : ''}
                  </div>
                </div>
              ` : ''}
            </div>

            <!-- Details Tab -->
            <div class="bme-tab-pane" data-pane="details">
              <div class="bme-property-section">
                <h3>Interior Features</h3>
                <div class="bme-property-grid">
                  <div class="bme-grid-item"><label>Bedrooms:</label><span>${listing.bedrooms_total || 0}</span></div>
                  <div class="bme-grid-item"><label>Bathrooms Full:</label><span>${listing.bathrooms_full || 0}</span></div>
                  <div class="bme-grid-item"><label>Bathrooms Half:</label><span>${listing.bathrooms_half || 0}</span></div>
                  <div class="bme-grid-item"><label>Bathrooms Total:</label><span>${listing.bathrooms_total_decimal || 0}</span></div>
                  <div class="bme-grid-item"><label>Fireplace:</label><span>${listing.fireplace_yn === 'true' || listing.fireplace_yn === 1 ? 'Yes' : 'No'}</span></div>
                  ${listing.fireplaces_total ? `<div class="bme-grid-item"><label>Number of Fireplaces:</label><span>${listing.fireplaces_total}</span></div>` : ''}
                  ${listing.fireplace_features ? `<div class="bme-grid-item full-width"><label>Fireplace Features:</label><span>${formatArray(listing.fireplace_features)}</span></div>` : ''}
                  ${listing.main_level_bedrooms ? `<div class="bme-grid-item"><label>Main Level Bedrooms:</label><span>${listing.main_level_bedrooms}</span></div>` : ''}
                  ${listing.main_level_bathrooms ? `<div class="bme-grid-item"><label>Main Level Bathrooms:</label><span>${listing.main_level_bathrooms}</span></div>` : ''}
                  ${listing.flooring ? `<div class="bme-grid-item full-width"><label>Flooring:</label><span>${formatArray(listing.flooring)}</span></div>` : ''}
                  ${listing.interior_features ? `<div class="bme-grid-item full-width"><label>Interior Features:</label><span>${formatArray(listing.interior_features)}</span></div>` : ''}
                  ${listing.appliances ? `<div class="bme-grid-item full-width"><label>Appliances:</label><span>${formatArray(listing.appliances)}</span></div>` : ''}
                  ${listing.window_features ? `<div class="bme-grid-item full-width"><label>Windows:</label><span>${formatArray(listing.window_features)}</span></div>` : ''}
                  ${listing.door_features ? `<div class="bme-grid-item full-width"><label>Doors:</label><span>${formatArray(listing.door_features)}</span></div>` : ''}
                  ${listing.laundry_features ? `<div class="bme-grid-item full-width"><label>Laundry:</label><span>${formatArray(listing.laundry_features)}</span></div>` : ''}
                  ${listing.rooms_total ? `<div class="bme-grid-item"><label>Total Rooms:</label><span>${listing.rooms_total}</span></div>` : ''}
                  ${listing.property_condition ? `<div class="bme-grid-item"><label>Property Condition:</label><span>${listing.property_condition}</span></div>` : ''}
                  ${listing.basement ? `<div class="bme-grid-item full-width"><label>Basement:</label><span>${formatArray(listing.basement)}</span></div>` : ''}
                  ${listing.home_warranty_yn ? `<div class="bme-grid-item"><label>Home Warranty:</label><span>${listing.home_warranty_yn === 'true' || listing.home_warranty_yn === 1 ? 'Yes' : 'No'}</span></div>` : ''}
                </div>
              </div>

              <div class="bme-property-section">
                <h3>Exterior Features</h3>
                <div class="bme-property-grid">
                  ${listing.lot_features ? `<div class="bme-grid-item full-width"><label>Lot Features:</label><span>${formatArray(listing.lot_features)}</span></div>` : ''}
                  ${listing.exterior_features ? `<div class="bme-grid-item full-width"><label>Exterior Features:</label><span>${formatArray(listing.exterior_features)}</span></div>` : ''}
                  ${listing.patio_and_porch_features ? `<div class="bme-grid-item full-width"><label>Patio/Porch:</label><span>${formatArray(listing.patio_and_porch_features)}</span></div>` : ''}
                  ${listing.roof ? `<div class="bme-grid-item"><label>Roof:</label><span>${formatArray(listing.roof)}</span></div>` : ''}
                  ${listing.construction_materials ? `<div class="bme-grid-item"><label>Construction:</label><span>${formatArray(listing.construction_materials)}</span></div>` : ''}
                  ${listing.foundation_details ? `<div class="bme-grid-item"><label>Foundation:</label><span>${formatArray(listing.foundation_details)}</span></div>` : ''}
                  ${listing.lot_size_acres ? `<div class="bme-grid-item"><label>Lot Size (Acres):</label><span>${listing.lot_size_acres}</span></div>` : ''}
                  ${listing.fencing ? `<div class="bme-grid-item full-width"><label>Fencing:</label><span>${formatArray(listing.fencing)}</span></div>` : ''}
                  ${listing.frontage_length ? `<div class="bme-grid-item"><label>Frontage Length:</label><span>${listing.frontage_length}</span></div>` : ''}
                  ${listing.frontage_type ? `<div class="bme-grid-item"><label>Frontage Type:</label><span>${formatArray(listing.frontage_type)}</span></div>` : ''}
                  ${listing.road_surface_type ? `<div class="bme-grid-item"><label>Road Surface:</label><span>${formatArray(listing.road_surface_type)}</span></div>` : ''}
                  ${listing.road_frontage_type ? `<div class="bme-grid-item"><label>Road Frontage:</label><span>${formatArray(listing.road_frontage_type)}</span></div>` : ''}
                  ${listing.road_responsibility ? `<div class="bme-grid-item"><label>Road Responsibility:</label><span>${formatArray(listing.road_responsibility)}</span></div>` : ''}
                  ${listing.number_of_lots ? `<div class="bme-grid-item"><label>Number of Lots:</label><span>${listing.number_of_lots}</span></div>` : ''}
                  ${listing.additional_parcels_yn ? `<div class="bme-grid-item"><label>Additional Parcels:</label><span>${listing.additional_parcels_yn === 'true' || listing.additional_parcels_yn === 1 ? 'Yes' : 'No'}</span></div>` : ''}
                  <div class="bme-grid-item"><label>Parking Total:</label><span>${listing.parking_total || 'N/A'}</span></div>
                  ${listing.parking_features ? `<div class="bme-grid-item full-width"><label>Parking Features:</label><span>${formatArray(listing.parking_features)}</span></div>` : ''}
                  ${listing.carport_yn ? `<div class="bme-grid-item"><label>Carport:</label><span>${listing.carport_yn === 'true' || listing.carport_yn === 1 ? 'Yes' : 'No'}</span></div>` : ''}
                </div>
              </div>

              ${(listing.pool_features || listing.pool_private_yn || listing.spa_features || listing.spa_yn || listing.waterfront_yn || listing.waterfront_features || listing.view_yn || listing.view) ? `
                <div class="bme-property-section">
                  <h3>Pool, Spa & Waterfront</h3>
                  <div class="bme-property-grid">
                    ${listing.pool_features ? `<div class="bme-grid-item full-width"><label>Pool Features:</label><span>${formatArray(listing.pool_features)}</span></div>` : ''}
                    ${listing.pool_private_yn ? `<div class="bme-grid-item"><label>Private Pool:</label><span>${listing.pool_private_yn === 'true' || listing.pool_private_yn === 1 ? 'Yes' : 'No'}</span></div>` : ''}
                    ${listing.spa_yn ? `<div class="bme-grid-item"><label>Spa:</label><span>${listing.spa_yn === 'true' || listing.spa_yn === 1 ? 'Yes' : 'No'}</span></div>` : ''}
                    ${listing.spa_features ? `<div class="bme-grid-item full-width"><label>Spa Features:</label><span>${formatArray(listing.spa_features)}</span></div>` : ''}
                    ${listing.waterfront_yn ? `<div class="bme-grid-item"><label>Waterfront:</label><span>${listing.waterfront_yn === 'true' || listing.waterfront_yn === 1 ? 'Yes' : 'No'}</span></div>` : ''}
                    ${listing.waterfront_features ? `<div class="bme-grid-item full-width"><label>Waterfront Features:</label><span>${formatArray(listing.waterfront_features)}</span></div>` : ''}
                    ${listing.view_yn ? `<div class="bme-grid-item"><label>Has View:</label><span>${listing.view_yn === 'true' || listing.view_yn === 1 ? 'Yes' : 'No'}</span></div>` : ''}
                    ${listing.view ? `<div class="bme-grid-item full-width"><label>View:</label><span>${formatArray(listing.view)}</span></div>` : ''}
                  </div>
                </div>
              ` : ''}

              <div class="bme-property-section">
                <h3>Utilities & Systems</h3>
                <div class="bme-property-grid">
                  ${listing.cooling ? `<div class="bme-grid-item"><label>Cooling:</label><span>${formatArray(listing.cooling)}</span></div>` : ''}
                  ${listing.heating ? `<div class="bme-grid-item"><label>Heating:</label><span>${formatArray(listing.heating)}</span></div>` : ''}
                  ${listing.sewer ? `<div class="bme-grid-item"><label>Sewer:</label><span>${formatArray(listing.sewer)}</span></div>` : ''}
                  ${listing.water_source ? `<div class="bme-grid-item"><label>Water:</label><span>${formatArray(listing.water_source)}</span></div>` : ''}
                  ${listing.electric ? `<div class="bme-grid-item"><label>Electric:</label><span>${formatArray(listing.electric)}</span></div>` : ''}
                  ${listing.gas ? `<div class="bme-grid-item"><label>Gas:</label><span>${formatArray(listing.gas)}</span></div>` : ''}
                  ${listing.utilities ? `<div class="bme-grid-item full-width"><label>Utilities:</label><span>${formatArray(listing.utilities)}</span></div>` : ''}
                  ${listing.electric_on_property_yn ? `<div class="bme-grid-item"><label>Electric On Property:</label><span>${listing.electric_on_property_yn === 'true' || listing.electric_on_property_yn === 1 ? 'Yes' : 'No'}</span></div>` : ''}
                </div>
              </div>
            </div>

            <!-- Financial Tab -->
            <div class="bme-tab-pane" data-pane="financial">
              <div class="bme-property-section">
                <h3>Pricing Information</h3>
                <div class="bme-property-grid">
                  <div class="bme-grid-item"><label>List Price:</label><span>${formatCurrency(listing.list_price)}</span></div>
                  ${listing.close_price ? `<div class="bme-grid-item"><label>Close Price:</label><span>${formatCurrency(listing.close_price)}</span></div>` : ''}
                  ${listing.original_list_price ? `<div class="bme-grid-item"><label>Original List Price:</label><span>${formatCurrency(listing.original_list_price)}</span></div>` : ''}
                  ${listing.list_price_low ? `<div class="bme-grid-item"><label>List Price Low:</label><span>${formatCurrency(listing.list_price_low)}</span></div>` : ''}
                  ${listing.price_change_timestamp ? `<div class="bme-grid-item"><label>Price Change Date:</label><span>${formatDate(listing.price_change_timestamp)}</span></div>` : ''}
                  ${listing.days_on_market ? `<div class="bme-grid-item"><label>Days on Market:</label><span>${listing.days_on_market}</span></div>` : ''}
                  ${listing.cumulative_days_on_market ? `<div class="bme-grid-item"><label>Cumulative DOM:</label><span>${listing.cumulative_days_on_market}</span></div>` : ''}
                </div>
              </div>

              <div class="bme-property-section">
                <h3>Taxes & Fees</h3>
                <div class="bme-property-grid">
                  ${listing.tax_annual_amount ? `<div class="bme-grid-item"><label>Annual Tax:</label><span>${formatCurrency(listing.tax_annual_amount)}</span></div>` : ''}
                  ${listing.tax_year ? `<div class="bme-grid-item"><label>Tax Year:</label><span>${listing.tax_year}</span></div>` : ''}
                  ${listing.tax_assessed_value ? `<div class="bme-grid-item"><label>Assessed Value:</label><span>${formatCurrency(listing.tax_assessed_value)}</span></div>` : ''}
                  ${listing.parcel_number ? `<div class="bme-grid-item"><label>Parcel Number:</label><span>${listing.parcel_number}</span></div>` : ''}
                  ${listing.association_yn ? `<div class="bme-grid-item"><label>HOA/Association:</label><span>${listing.association_yn === 'true' || listing.association_yn === 1 ? 'Yes' : 'No'}</span></div>` : ''}
                  ${listing.association_fee ? `<div class="bme-grid-item"><label>HOA Fee:</label><span>${formatCurrency(listing.association_fee)}</span></div>` : ''}
                  ${listing.association_fee_frequency ? `<div class="bme-grid-item"><label>HOA Fee Frequency:</label><span>${listing.association_fee_frequency}</span></div>` : ''}
                  ${listing.association_amenities ? `<div class="bme-grid-item full-width"><label>HOA Amenities:</label><span>${formatArray(listing.association_amenities)}</span></div>` : ''}
                  ${listing.association_fee_includes ? `<div class="bme-grid-item full-width"><label>HOA Fee Includes:</label><span>${formatArray(listing.association_fee_includes)}</span></div>` : ''}
                </div>
              </div>

              ${(listing.gross_income || listing.net_operating_income || listing.operating_expense || listing.total_actual_rent) ? `
                <div class="bme-property-section">
                  <h3>Investment/Rental Information</h3>
                  <div class="bme-property-grid">
                    ${listing.gross_income ? `<div class="bme-grid-item"><label>Gross Income:</label><span>${formatCurrency(listing.gross_income)}</span></div>` : ''}
                    ${listing.gross_scheduled_income ? `<div class="bme-grid-item"><label>Gross Scheduled Income:</label><span>${formatCurrency(listing.gross_scheduled_income)}</span></div>` : ''}
                    ${listing.net_operating_income ? `<div class="bme-grid-item"><label>Net Operating Income:</label><span>${formatCurrency(listing.net_operating_income)}</span></div>` : ''}
                    ${listing.operating_expense ? `<div class="bme-grid-item"><label>Operating Expense:</label><span>${formatCurrency(listing.operating_expense)}</span></div>` : ''}
                    ${listing.total_actual_rent ? `<div class="bme-grid-item"><label>Total Actual Rent:</label><span>${formatCurrency(listing.total_actual_rent)}</span></div>` : ''}
                    ${listing.lease_term ? `<div class="bme-grid-item"><label>Lease Term:</label><span>${listing.lease_term}</span></div>` : ''}
                    ${listing.existing_lease_type ? `<div class="bme-grid-item"><label>Existing Lease Type:</label><span>${listing.existing_lease_type}</span></div>` : ''}
                    ${listing.availability_date ? `<div class="bme-grid-item"><label>Available Date:</label><span>${formatDate(listing.availability_date)}</span></div>` : ''}
                    ${listing.rent_includes ? `<div class="bme-grid-item full-width"><label>Rent Includes:</label><span>${formatArray(listing.rent_includes)}</span></div>` : ''}
                    ${listing.tenant_pays ? `<div class="bme-grid-item full-width"><label>Tenant Pays:</label><span>${formatArray(listing.tenant_pays)}</span></div>` : ''}
                    ${listing.concessions_amount ? `<div class="bme-grid-item"><label>Seller Concessions:</label><span>${formatCurrency(listing.concessions_amount)}</span></div>` : ''}
                    ${listing.current_financing ? `<div class="bme-grid-item full-width"><label>Current Financing:</label><span>${formatArray(listing.current_financing)}</span></div>` : ''}
                    ${listing.development_status ? `<div class="bme-grid-item"><label>Development Status:</label><span>${listing.development_status}</span></div>` : ''}
                  </div>
                </div>
              ` : ''}

              ${(listing.zoning || listing.zoning_description) ? `
                <div class="bme-property-section">
                  <h3>Zoning & Legal</h3>
                  <div class="bme-property-grid">
                    ${listing.zoning ? `<div class="bme-grid-item"><label>Zoning:</label><span>${listing.zoning}</span></div>` : ''}
                    ${listing.zoning_description ? `<div class="bme-grid-item full-width"><label>Zoning Description:</label><span>${listing.zoning_description}</span></div>` : ''}
                  </div>
                </div>
              ` : ''}

              ${(listing.buyer_agency_compensation || listing.listing_agreement || listing.listing_terms) ? `
                <div class="bme-property-section">
                  <h3>Listing Agreement & Compensation</h3>
                  <div class="bme-property-grid">
                    ${listing.listing_agreement ? `<div class="bme-grid-item"><label>Listing Agreement:</label><span>${listing.listing_agreement}</span></div>` : ''}
                    ${listing.listing_service ? `<div class="bme-grid-item"><label>Listing Service:</label><span>${listing.listing_service}</span></div>` : ''}
                    ${listing.listing_terms ? `<div class="bme-grid-item full-width"><label>Listing Terms:</label><span>${formatArray(listing.listing_terms)}</span></div>` : ''}
                    ${listing.buyer_agency_compensation ? `<div class="bme-grid-item"><label>Buyer Agency Compensation:</label><span>${listing.buyer_agency_compensation}</span></div>` : ''}
                    ${listing.buyer_agency_compensation_type ? `<div class="bme-grid-item"><label>Compensation Type:</label><span>${listing.buyer_agency_compensation_type}</span></div>` : ''}
                  </div>
                </div>
              ` : ''}
            </div>

            <!-- Features Tab -->
            <div class="bme-tab-pane" data-pane="features">
              <div class="bme-property-section">
                <h3>Property Features</h3>
                <div class="bme-features-list">
                  ${listing.accessibility_features ? `<div class="bme-feature-item"><strong>Accessibility:</strong> ${formatArray(listing.accessibility_features)}</div>` : ''}
                  ${listing.community_features ? `<div class="bme-feature-item"><strong>Community:</strong> ${formatArray(listing.community_features)}</div>` : ''}
                  ${listing.security_features ? `<div class="bme-feature-item"><strong>Security:</strong> ${formatArray(listing.security_features)}</div>` : ''}
                  ${listing.architectural_style ? `<div class="bme-feature-item"><strong>Architectural Style:</strong> ${formatArray(listing.architectural_style)}</div>` : ''}
                  ${listing.pets_allowed ? `<div class="bme-feature-item"><strong>Pets Allowed:</strong> ${formatArray(listing.pets_allowed)}</div>` : ''}
                  ${listing.senior_community_yn ? `<div class="bme-feature-item"><strong>Senior Community:</strong> ${listing.senior_community_yn === 'true' || listing.senior_community_yn === 1 ? 'Yes' : 'No'}</div>` : ''}
                  ${listing.green_energy_generation ? `<div class="bme-feature-item"><strong>Green Energy:</strong> ${formatArray(listing.green_energy_generation)}</div>` : ''}
                  ${listing.green_energy_efficient ? `<div class="bme-feature-item"><strong>Energy Efficient:</strong> ${formatArray(listing.green_energy_efficient)}</div>` : ''}
                  ${listing.green_water_conservation ? `<div class="bme-feature-item"><strong>Water Conservation:</strong> ${formatArray(listing.green_water_conservation)}</div>` : ''}
                  ${listing.green_indoor_air_quality ? `<div class="bme-feature-item"><strong>Indoor Air Quality:</strong> ${formatArray(listing.green_indoor_air_quality)}</div>` : ''}
                </div>
              </div>

              ${(listing.horse_yn || listing.horse_amenities || listing.wooded_area || listing.pasture_area || listing.cultivated_area) ? `
                <div class="bme-property-section">
                  <h3>Land & Agricultural Features</h3>
                  <div class="bme-property-grid">
                    ${listing.horse_yn ? `<div class="bme-grid-item"><label>Horse Property:</label><span>${listing.horse_yn === 'true' || listing.horse_yn === 1 ? 'Yes' : 'No'}</span></div>` : ''}
                    ${listing.horse_amenities ? `<div class="bme-grid-item full-width"><label>Horse Amenities:</label><span>${formatArray(listing.horse_amenities)}</span></div>` : ''}
                    ${listing.wooded_area ? `<div class="bme-grid-item"><label>Wooded Area:</label><span>${listing.wooded_area}</span></div>` : ''}
                    ${listing.pasture_area ? `<div class="bme-grid-item"><label>Pasture Area:</label><span>${listing.pasture_area}</span></div>` : ''}
                    ${listing.cultivated_area ? `<div class="bme-grid-item"><label>Cultivated Area:</label><span>${listing.cultivated_area}</span></div>` : ''}
                    ${listing.other_structures ? `<div class="bme-grid-item full-width"><label>Other Structures:</label><span>${formatArray(listing.other_structures)}</span></div>` : ''}
                    ${listing.other_equipment ? `<div class="bme-grid-item full-width"><label>Equipment Included:</label><span>${formatArray(listing.other_equipment)}</span></div>` : ''}
                  </div>
                </div>
              ` : ''}
            </div>

            <!-- Rooms Tab -->
            ${rooms.length > 0 ? `
              <div class="bme-tab-pane" data-pane="rooms">
                <div class="bme-property-section">
                  <h3>Room Details</h3>
                  <div class="bme-rooms-list">
                    ${rooms.map(room => `
                      <div class="bme-room-item">
                        <h4>${room.room_type || 'Room'}${room.room_level ? ` - ${room.room_level}` : ''}</h4>
                        ${room.room_dimensions ? `<p><strong>Dimensions:</strong> ${room.room_dimensions}</p>` : ''}
                        ${room.room_features ? `<p><strong>Features:</strong> ${formatArray(room.room_features)}</p>` : ''}
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>
            ` : ''}

            <!-- Open Houses Tab -->
            ${openHouses.length > 0 ? `
              <div class="bme-tab-pane" data-pane="openhouses">
                <div class="bme-property-section">
                  <h3>Scheduled Open Houses</h3>
                  <div class="bme-openhouses-list">
                    ${openHouses.map(oh => `
                      <div class="bme-openhouse-item">
                        <p><strong>Date:</strong> ${formatDate(oh.date)}</p>
                        <p><strong>Time:</strong> ${formatTime(oh.start_time)} - ${formatTime(oh.end_time)}</p>
                        ${oh.method ? `<p><strong>Method:</strong> ${oh.method}</p>` : ''}
                        ${oh.remarks ? `<p><strong>Details:</strong> ${oh.remarks}</p>` : ''}
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>
            ` : ''}

            <!-- History Tab -->
            ${history.length > 0 ? `
              <div class="bme-tab-pane" data-pane="history">
                <div class="bme-property-section">
                  <h3>Property History</h3>
                  <div class="bme-history-list">
                    ${history.map(event => `
                      <div class="bme-history-item">
                        <div class="bme-history-date">${formatDate(event.event_date)}</div>
                        <div class="bme-history-details">
                          <strong>${event.event_type || 'Event'}</strong>
                          ${event.new_price ? `<span class="bme-history-price">${formatCurrency(event.new_price)}</span>` : ''}
                          ${event.old_price && event.old_price != event.new_price ? `<span class="bme-history-old-price">(was ${formatCurrency(event.old_price)})</span>` : ''}
                          ${event.new_status ? `<span class="bme-history-status">${event.new_status}</span>` : ''}
                          ${event.days_on_market ? `<span class="bme-history-dom">${event.days_on_market} days</span>` : ''}
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `;

      this.showPropertyModal(html);
      this.initPropertyTabs();
      this.initPhotoGallery();
    },

    /**
     * Initialize property tabs
     */
    initPropertyTabs() {
      $(document).on('click', '.bme-tab', function(e) {
        e.preventDefault();
        const tab = $(this).data('tab');

        $('.bme-tab').removeClass('active');
        $(this).addClass('active');

        $('.bme-tab-pane').removeClass('active');
        $(`.bme-tab-pane[data-pane="${tab}"]`).addClass('active');
      });
    },

    /**
     * Initialize photo gallery
     */
    initPhotoGallery() {
      const self = this;
      let currentIndex = 0;

      // Update photo display
      const updatePhoto = (index) => {
        const thumbs = $('.bme-photo-thumb');
        if (thumbs.length === 0) return;

        currentIndex = Math.max(0, Math.min(index, thumbs.length - 1));

        $('.bme-photo-thumb').removeClass('active');
        $(thumbs[currentIndex]).addClass('active');

        const newSrc = $(thumbs[currentIndex]).attr('src');
        $('.bme-main-photo').attr('src', newSrc);
        $('.current-photo').text(currentIndex + 1);

        // Scroll thumbnail into view
        const thumbContainer = $('.bme-photo-thumbnails');
        const activeThumb = $(thumbs[currentIndex]);
        if (thumbContainer.length && activeThumb.length) {
          const scrollLeft = activeThumb.position().left + thumbContainer.scrollLeft() - (thumbContainer.width() / 2) + (activeThumb.width() / 2);
          thumbContainer.animate({ scrollLeft: scrollLeft }, 300);
        }
      };

      // Thumbnail click
      $(document).on('click', '.bme-photo-thumb', function() {
        const index = $(this).data('index');
        updatePhoto(index);
      });

      // Previous button
      $(document).on('click', '.bme-photo-prev', function(e) {
        e.preventDefault();
        updatePhoto(currentIndex - 1);
      });

      // Next button
      $(document).on('click', '.bme-photo-next', function(e) {
        e.preventDefault();
        updatePhoto(currentIndex + 1);
      });

      // Keyboard navigation
      $(document).on('keydown', function(e) {
        if ($('#bme-property-modal').hasClass('active')) {
          if (e.key === 'ArrowLeft') {
            updatePhoto(currentIndex - 1);
          } else if (e.key === 'ArrowRight') {
            updatePhoto(currentIndex + 1);
          }
        }
      });
    },
  };

  // Initialize when document is ready
  $(document).ready(function () {
    BME.init();
    BME.initCharts();
  });

  // Make BME object globally available
  window.BME = BME;
})(jQuery);
