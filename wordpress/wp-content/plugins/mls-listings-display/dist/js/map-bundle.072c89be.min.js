(self.webpackChunkmls_listings_display=self.webpackChunkmls_listings_display||[]).push([[396],{127:function(e,t,o){var i=o(692);const a={startTime:performance.now(),marks:{},mark(e){const t=(performance.now()-this.startTime).toFixed(2);this.marks[e]=t},measure(e,t,o){const i=parseFloat(this.marks[t]||0);return(parseFloat(this.marks[o]||performance.now()-this.startTime)-i).toFixed(2)},summary(){const e=((performance.now()-this.startTime)/1e3).toFixed(2),t=bmeMapData&&bmeMapData.available_cities&&Array.isArray(bmeMapData.available_cities);t&&bmeMapData.available_cities.length;let o=0;if(["MLD Init Started","Map Created","Geolocation Success","Geocoding Complete","City Check Started","City Check Complete","Loading Listings","AJAX Response Received","Rendering Started","Markers Rendered","Sidebar Updated","Listings Loaded"].forEach(e=>{if(this.marks[e]){const t=this.marks[e];o=t}}),this.marks["City Check Complete"]&&this.marks["City Check Started"]){this.marks["City Check Complete"],this.marks["City Check Started"]}if(this.marks["Listings Loaded"]&&this.marks["Loading Listings"]){this.marks["Listings Loaded"],this.marks["Loading Listings"]}if(e>2&&this.marks["City Check Complete"]&&this.marks["City Check Started"]){this.marks["City Check Complete"],this.marks["City Check Started"]}}},n={isInitialized:!1,map:null,markers:[],openPopupIds:new Set,autocompleteRequest:null,debounceTimer:null,countUpdateTimer:null,isInitialLoad:!0,hasUrlFilters:!1,isAdjustingMapBounds:!1,hasInitialFetch:!1,isLoadingAfterGeolocation:!1,lastMapState:{lat:0,lng:0,zoom:0},AdvancedMarkerElement:null,selectedPropertyType:"Residential",keywordFilters:{},modalFilters:{},isNearbySearchActive:!1,isSpecificPropertySearch:!1,lastSearchType:null,openPopoutWindows:{},subtypeCustomizations:{},priceSliderData:{min:0,display_max:0,distribution:[],outlier_count:0},isDrawingMode:!1,drawnPolygons:[],currentDrawingPolygon:null,currentEditingPolygon:null,mapboxDraw:null,isFreehandDrawing:!1,freehandPath:[],freehandPolyline:null,isClickDrawing:!1,clickDrawingPath:[],clickDrawingPolygon:null,clickDrawingListener:null,doubleClickListener:null,clickDrawingMarkers:[],init(){if(this.isInitialized)return;a.mark("MLD Init Started");const e=document.getElementById("bme-map-container");i("#bme-redirect-loading").remove(),!e||this.isInitialized||e.classList.contains("mld-map-initialized")||("undefined"!=typeof bmeMapData?(s.initListingsResize(),"undefined"!=typeof MLD_CityBoundaries&&MLD_CityBoundaries.init(),this.isInitialized=!0,"google"===bmeMapData.provider?this.waitForGoogleMaps():this.run()):MLDLogger.error("MLD Error: Map data (bmeMapData) is not available."))},waitForGoogleMaps(){const e=this,t=setInterval(function(){"undefined"!=typeof google&&void 0!==google.maps&&void 0!==google.maps.marker&&(clearInterval(t),e.run())},100)},waitForMapReadyAndRefresh(e,t=null){const o=this;let i=0;setTimeout(function a(){i++;try{const n=s.getMapBounds(),r=o.map?s.getNormalizedCenter(o.map):null;if(n&&n.north&&n.south&&n.east&&n.west&&r){let i=!0;if(t){const e=Math.abs(r.lat-t.lat),o=Math.abs(r.lng-t.lng);i=e<.001&&o<.001,i||MLDLogger.debug(`Map position not settled yet. Target: ${t.lat}, ${t.lng}, Current: ${r.lat}, ${r.lng}`)}let a=!1;if("google"===e?a=o.map&&"function"==typeof o.map.getBounds&&i:"mapbox"===e&&(a=o.map&&o.map.loaded()&&!o.map.isMoving()&&i),a)return void("undefined"!=typeof MLD_API&&"function"==typeof MLD_API.refreshMapListings&&(window.MLD_StateRestorationInProgress=!0,o.isRestoringVisitorState=!0,MLD_API.refreshMapListings(!0),setTimeout(()=>{window.MLD_StateRestorationInProgress=!1,o.isRestoringVisitorState=!1},2e3)))}i<50?setTimeout(a,100):(MLDLogger.warning(`Map did not become ready within timeout after ${i} attempts, forcing refresh anyway`),MLDLogger.debug("Final bounds:",n),MLDLogger.debug("Final center:",r),"undefined"!=typeof MLD_API&&"function"==typeof MLD_API.refreshMapListings&&MLD_API.refreshMapListings(!0))}catch(e){MLDLogger.error("Error checking map readiness:",e),i<50&&setTimeout(a,100)}},200)},run(){document.getElementById("bme-map-container").classList.add("mld-map-initialized"),this.isInitialized=!0,this.subtypeCustomizations=bmeMapData.subtype_customizations||{},this.modalFilters=MLD_Filters.getModalDefaults(),document.body.classList.add("mld-map-active"),this.initMap(),s.initViewModeToggle(),window.innerWidth<=768&&setTimeout(()=>{s.preventMobileZoom()},500)},async initMap(){a.mark("Map Init Started");const e=document.getElementById("bme-map-container"),t={lat:42.3601,lng:-71.0589},o=[-71.0589,42.3601];if(a.mark("Fresh Session Start"),i("#bme-nearby-toggle").prop("checked",!1),this.isNearbySearchActive=!1,this.pendingGeolocation=!1,"google"===bmeMapData.provider)try{const{Map:o}=await google.maps.importLibrary("maps"),i=await google.maps.importLibrary("marker");this.AdvancedMarkerElement=i.AdvancedMarkerElement,a.mark("Creating Map");const n=t,r=13;this.map=new o(e,{center:n,zoom:r,mapId:"BME_MAP_ID",gestureHandling:"greedy",fullscreenControl:!1,mapTypeControl:!1,streetViewControl:!1,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},minZoom:9,clickableIcons:!1,disableDefaultUI:!1}),this.overlay=new google.maps.OverlayView,this.overlay.draw=function(){},this.overlay.setMap(this.map),a.mark("Map Created");let l=null,d=0,c=0;const g=3;this.map.addListener("idle",()=>{if(d++,MLDLogger.debug("Map idle event #"+d,{isInitialLoad:this.isInitialLoad,hasInitialFetch:this.hasInitialFetch,bounds:s.getMapBounds()}),this.pendingGeolocation&&1===d)return a.mark("Starting Geolocation"),this.pendingGeolocation=!1,this.hasInitialFetch=!0,this.isInitialLoad=!1,void s.attemptGeolocationWithCityDetection();if(this.isInitialLoad){const e=s.getMapBounds();return!e&&c<g?(c++,MLDLogger.debug("No bounds available, retry attempt",c),clearTimeout(l),void(l=setTimeout(()=>{google.maps.event.trigger(this.map,"idle")},500))):void(!this.hasInitialFetch&&(e||c>=g)&&(this.hasInitialFetch=!0,clearTimeout(l),l=setTimeout(()=>{MLDLogger.debug("Initial fetch triggered",e?"with bounds":"without bounds (fallback)"),MLD_API.refreshMapListings(!0)},100)))}this.isLoadingAfterGeolocation||(clearTimeout(l),l=setTimeout(()=>{MLD_API.refreshMapListings(!1)},250))})}catch(t){return MLDLogger.error("Error loading Google Maps libraries:",t),void(e.innerHTML="<p>Error: Could not load the map. Please check the API key and console for details.</p>")}else{mapboxgl.accessToken=bmeMapData.mapbox_key;let e=o,t=13;this.map=new mapboxgl.Map({container:"bme-map-container",style:"mapbox://styles/mapbox/streets-v11",center:e,zoom:t}),this.map.addControl(new mapboxgl.NavigationControl({showCompass:!1,showZoom:!0,visualizePitch:!1}),"bottom-right");let i=null,a=0,n=0;const r=3;this.map.on("idle",()=>{if(a++,MLDLogger.debug("Map idle event #"+a,{isInitialLoad:this.isInitialLoad,hasInitialFetch:this.hasInitialFetch,bounds:s.getMapBounds()}),this.pendingGeolocation&&1===a)return this.pendingGeolocation=!1,this.hasInitialFetch=!0,this.isInitialLoad=!1,void setTimeout(()=>{s.attemptGeolocationWithCityDetection()},500);if(this.isInitialLoad){const e=s.getMapBounds();return!e&&n<r?(n++,MLDLogger.debug("No bounds available, retry attempt",n),clearTimeout(i),void(i=setTimeout(()=>{this.map.fire("idle")},500))):void(!this.hasInitialFetch&&(e||n>=r)&&(this.hasInitialFetch=!0,clearTimeout(i),i=setTimeout(()=>{MLDLogger.debug("Initial fetch triggered",e?"with bounds":"without bounds (fallback)"),MLD_API.refreshMapListings(!0)},100)))}this.isAdjustingMapBounds||this.isLoadingAfterGeolocation||(clearTimeout(i),i=setTimeout(()=>{this.isAdjustingMapBounds||this.isLoadingAfterGeolocation||MLD_API.refreshMapListings(!1)},250))})}this.postInitSetup(),this.initDrawingTools()},postInitSetup(){MLD_Filters.initSearchAndFilters(),s.initEventDelegation(),MLD_Filters.initPriceSlider(),function(){const e=n;if(!e.map)return;const t=document.getElementById("bme-satellite-toggle");if(t){const o=t.closest(".bme-control-item");if("google"!==bmeMapData.provider&&o)return void(o.style.display="none");t.addEventListener("change",function(){if(e.map&&"google"===bmeMapData.provider){const t=this.checked;e.map.setMapTypeId(t?"satellite":"roadmap")}}),t.checked=!1}}(),this.hasUrlFilters=s.restoreStateFromUrl(),s.setupPropertyTypeSelectors(),i("#bme-property-type-select").val(this.selectedPropertyType).trigger("change",[!0])},initDrawingTools(){if(i("#bme-reset-button").hide().addClass("force-hidden"),this.updatePolygonUI(),window.innerWidth<=768){const e=i("#bme-half-map-wrapper").hasClass("view-mode-map")?"map":"list";this.toggleMapControlsVisibility(e)}"google"===bmeMapData.provider?MLDLogger.info("Polygon drawing initialized"):"undefined"!=typeof MapboxDraw&&(this.mapboxDraw=new MapboxDraw({displayControlsDefault:!1,controls:{polygon:!0,trash:!0},styles:[{id:"gl-draw-polygon-fill",type:"fill",filter:["all",["==","$type","Polygon"]],paint:{"fill-color":"#2196F3","fill-opacity":.2}},{id:"gl-draw-polygon-stroke",type:"line",filter:["all",["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#2196F3","line-width":2}}]}),this.map.addControl(this.mapboxDraw,"top-left"),this.map.on("draw.create",e=>{this.handleMapboxPolygonComplete(e.features[0])}),this.map.on("draw.delete",e=>{this.handleMapboxPolygonDelete(e.features[0])}))},toggleDrawingMode(){this.isDrawingMode?this.exitDrawingMode():this.enterDrawingMode()},startNewShape(){const e=i,t=window.innerWidth<=768;t||e("#bme-complete-shape-button").show(),"google"===bmeMapData.provider?t?this.startFreehandDrawing():this.startClickBasedDrawing():this.mapboxDraw&&this.mapboxDraw.changeMode("draw_polygon")},completeCurrentShape(){const e=i;if(e("#bme-complete-shape-button").hide(),this.currentEditingPolygon&&("google"===bmeMapData.provider&&this.currentEditingPolygon.googlePolygon&&this.currentEditingPolygon.googlePolygon.setEditable(!1),this.currentEditingPolygon=null),"google"===bmeMapData.provider){if(this.isFreehandDrawing&&this.cancelFreehandDrawing(),this.isClickDrawing)return void this.completeClickDrawing()}else this.mapboxDraw&&this.mapboxDraw.changeMode("simple_select");this.drawnPolygons.length>0&&e("#bme-reset-button").show(),this.exitDrawingMode()},saveShapeName(e){const t=e.val().trim()||"Shape",o=e.siblings(".bme-polygon-name"),i=e.closest(".bme-polygon-item").data("polygon-id"),a=this.drawnPolygons.find(e=>e.id===i);a&&(a.name=t),o.text(t).show(),e.hide(),s.updateUrlHash()},enterDrawingMode(){const e=i;window.innerWidth;if(this.isDrawingMode=!0,MLD_Markers.clearMarkers(),e("#bme-drawing-panel").addClass("active"),e("#bme-draw-toggle").addClass("active"),this.drawnPolygons.length>0&&e("#bme-reset-button").show(),"google"===bmeMapData.provider){window.innerWidth<=768?this.startFreehandDrawing():this.startClickBasedDrawing()}else this.mapboxDraw;this.showExistingPolygons()},exitDrawingMode(){const e=i;this.isDrawingMode=!1,e("#bme-drawing-panel").removeClass("active"),e("#bme-draw-toggle").removeClass("active"),e("#bme-complete-shape-button").hide(),e("#bme-reset-button").hide(),"google"===bmeMapData.provider?(this.isFreehandDrawing&&this.cancelFreehandDrawing(),this.isClickDrawing&&this.cleanupClickDrawing()):this.mapboxDraw&&this.mapboxDraw.changeMode("simple_select"),this.drawnPolygons.length>0?MLD_API.refreshMapListings(!0):MLD_API.refreshMapListings(!1)},handlePolygonComplete(e){const t=window.innerWidth<=768,o=e.getPath(),i=[];for(let e=0;e<o.getLength();e++){const t=o.getAt(e);i.push([t.lat(),t.lng()])}const a={id:"polygon_"+Date.now(),name:"Shape "+(this.drawnPolygons.length+1),coordinates:i,googlePolygon:e,mapboxId:null};this.drawnPolygons.push(a),t||google.maps.event.addListener(e,"click",()=>{this.editPolygon(a.id)}),this.updatePolygonUI(),this.applyPolygonFilters(),this.exitDrawingMode()},handleMapboxPolygonComplete(e){const t=e.geometry.coordinates[0].map(e=>[e[1],e[0]]),o={id:e.id,coordinates:t,googlePolygon:null,mapboxId:e.id};this.drawnPolygons.push(o),this.updatePolygonUI(),this.applyPolygonFilters()},handleMapboxPolygonDelete(e){this.drawnPolygons=this.drawnPolygons.filter(t=>t.mapboxId!==e.id),this.updatePolygonUI(),this.applyPolygonFilters()},deletePolygon(e){const t=this.drawnPolygons.findIndex(t=>t.id===e);if(-1===t)return;const o=this.drawnPolygons[t];"google"===bmeMapData.provider&&o.googlePolygon?o.googlePolygon.setMap(null):this.mapboxDraw&&o.mapboxId&&this.mapboxDraw.delete(o.mapboxId),this.drawnPolygons.splice(t,1),this.updatePolygonUI(),this.applyPolygonFilters(),0===this.drawnPolygons.length&&i("#bme-reset-button").hide()},editPolygon(e){const t=this.drawnPolygons.find(t=>t.id===e);t&&"google"===bmeMapData.provider&&t.googlePolygon&&(t.googlePolygon.setEditable(!0),i("#bme-complete-shape-button").show(),this.currentEditingPolygon=t,t.pathListener||(t.pathListener=google.maps.event.addListener(t.googlePolygon.getPath(),"set_at",()=>{this.updatePolygonCoordinates(t)}),t.insertListener=google.maps.event.addListener(t.googlePolygon.getPath(),"insert_at",()=>{this.updatePolygonCoordinates(t)})))},updatePolygonCoordinates(e){if("google"===bmeMapData.provider&&e.googlePolygon){const t=e.googlePolygon.getPath(),o=[];for(let e=0;e<t.getLength();e++){const i=t.getAt(e);o.push([i.lat(),i.lng()])}e.coordinates=o,this.applyPolygonFilters()}},clearAllPolygons(){this.drawnPolygons.forEach(e=>{"google"===bmeMapData.provider&&e.googlePolygon&&e.googlePolygon.setMap(null)}),this.mapboxDraw&&this.mapboxDraw.deleteAll(),this.drawnPolygons=[],this.updatePolygonUI(),i("#bme-reset-button").hide().addClass("force-hidden"),this.isDrawingMode?this.exitDrawingMode():i("#bme-draw-toggle").removeClass("active"),this.applyPolygonFilters(),s.updateUrlHash()},updatePolygonUI(){const e=i,t=e("#bme-polygon-list");if(0===this.drawnPolygons.length)return t.html('<p class="bme-no-polygons">No shapes drawn yet</p>'),void e("#bme-reset-button").hide().addClass("force-hidden");e("#bme-reset-button").show().removeClass("force-hidden");let o="";this.drawnPolygons.forEach((e,t)=>{const i=e.name||`Shape ${t+1}`;o+=`\n\t\t\t\t<div class="bme-polygon-item" data-polygon-id="${e.id}">\n\t\t\t\t\t<span class="bme-polygon-name">${i}</span>\n\t\t\t\t\t<input type="text" class="bme-polygon-name-input" value="${i}" style="display: none;">\n\t\t\t\t\t<button class="bme-polygon-delete" title="Delete shape">×</button>\n\t\t\t\t</div>\n\t\t\t`}),t.html(o),t.find(".bme-polygon-delete").on("click",function(t){t.stopPropagation();const o=e(this).closest(".bme-polygon-item").data("polygon-id");n.deletePolygon(o)})},applyPolygonFilters(){if(this.drawnPolygons.length>0){["Building Name","MLS Area Major","MLS Area Minor","Postal Code","Street Name","Address"].forEach(e=>{delete n.keywordFilters[e]})}MLD_Filters.renderFilterTags(),s.updateUrlHash(),MLD_API.refreshMapListings(!0)},showExistingPolygons(){"google"===bmeMapData.provider&&this.drawnPolygons.forEach(e=>{e.googlePolygon&&e.googlePolygon.setMap(this.map)})},getPolygonCoordinates(){return this.drawnPolygons&&0!==this.drawnPolygons.length?this.drawnPolygons.map(e=>e.coordinates):null},startFreehandDrawing(){if(!this.map||this.isFreehandDrawing)return;const e=i;this.isFreehandDrawing=!0,this.freehandPath=[],this.isDrawingActive=!1,this.map.setOptions({draggable:!1,zoomControl:!1,scrollwheel:!1,disableDoubleClickZoom:!0});e("body").append('<div id="bme-drawing-instruction" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 8px; z-index: 10000; text-align: center;"><p style="margin: 0; font-size: 18px;">Draw on the map with your finger</p><p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.8;">Lift finger to complete shape</p></div>'),setTimeout(()=>{e("#bme-drawing-instruction").fadeOut(500,function(){e(this).remove()})},2e3),"google"===bmeMapData.provider&&(this.freehandPolyline=new google.maps.Polyline({path:[],strokeColor:"#2196F3",strokeOpacity:.8,strokeWeight:3,map:this.map}));const t=document.getElementById("bme-map-container"),o=e=>{if(!this.isFreehandDrawing)return;e.preventDefault(),e.stopPropagation(),this.isDrawingActive=!0;const t=e.touches[0],o=this.getTouchPoint(t);o&&(this.freehandPath=[o],this.freehandPolyline&&this.freehandPolyline.setPath(this.freehandPath))},a=e=>{if(!this.isFreehandDrawing||!this.isDrawingActive)return;e.preventDefault(),e.stopPropagation();const t=e.touches[0],o=this.getTouchPoint(t);if(o&&this.freehandPath.length>0){const e=this.freehandPath[this.freehandPath.length-1];this.calculateDistance(e,o)>1e-5&&(this.freehandPath.push(o),this.freehandPolyline&&this.freehandPolyline.setPath(this.freehandPath))}},n=e=>{this.isFreehandDrawing&&this.isDrawingActive&&(e.preventDefault(),e.stopPropagation(),this.isDrawingActive=!1,this.freehandPath.length<3?this.cancelFreehandDrawing():this.completeFreehandDrawing())};t.addEventListener("touchstart",o,{passive:!1}),t.addEventListener("touchmove",a,{passive:!1}),t.addEventListener("touchend",n,{passive:!1}),this.freehandHandlers={touchstart:o,touchmove:a,touchend:n}},calculateDistance(e,t){if(!e||!t)return 0;const o=e.lat(),i=e.lng(),a=t.lat(),n=t.lng();return Math.sqrt(Math.pow(a-o,2)+Math.pow(n-i,2))},getTouchPoint(e){if(!this.map||!e)return null;const t=document.getElementById("bme-map-container"),o=t.getBoundingClientRect(),i=e.clientX-o.left,a=e.clientY-o.top;if("google"===bmeMapData.provider){if(this.overlay&&this.overlay.getProjection){const e=this.overlay.getProjection();if(e){const t=new google.maps.Point(i,a);return e.fromContainerPixelToLatLng(t)}}const e=this.map.getBounds();if(!e)return null;const o=e.getNorthEast(),n=e.getSouthWest(),s=o.lat()-n.lat(),r=o.lng()-n.lng(),l=o.lat()-a/t.offsetHeight*s,d=n.lng()+i/t.offsetWidth*r;return new google.maps.LatLng(l,d)}return null},completeFreehandDrawing(){if(this.isFreehandDrawing&&!(this.freehandPath.length<3)){if("google"===bmeMapData.provider){const e=new google.maps.Polygon({paths:this.freehandPath,fillColor:"#2196F3",fillOpacity:.2,strokeColor:"#2196F3",strokeWeight:2,clickable:!0,editable:!1,map:this.map});this.handlePolygonComplete(e)}this.cleanupFreehandDrawing()}},cancelFreehandDrawing(){this.cleanupFreehandDrawing()},cleanupFreehandDrawing(){this.isFreehandDrawing=!1,this.isDrawingActive=!1,this.freehandPath=[],this.freehandPolyline&&(this.freehandPolyline.setMap(null),this.freehandPolyline=null),this.map&&this.map.setOptions({draggable:!0,zoomControl:!0,scrollwheel:!0,disableDoubleClickZoom:!1});const e=document.getElementById("bme-map-container");e&&this.freehandHandlers&&(e.removeEventListener("touchstart",this.freehandHandlers.touchstart,{passive:!1}),e.removeEventListener("touchmove",this.freehandHandlers.touchmove,{passive:!1}),e.removeEventListener("touchend",this.freehandHandlers.touchend,{passive:!1}),this.freehandHandlers=null),this.exitDrawingMode()},startClickBasedDrawing(){if(!this.map)return;this.isClickDrawing=!0,this.clickDrawingPath=[],this.clickDrawingPolygon=null,i("#bme-complete-shape-button").show();i("body").append('<div id="bme-drawing-instruction" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 8px; z-index: 10000; text-align: center; max-width: 350px;"><p style="margin: 0; font-size: 18px; font-weight: bold;">Click to Draw Polygon</p><p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.9;">• Click points to draw<br>• Need minimum 3 points<br>• Double-click to finish<br>• Or use "Complete Shape" button</p></div>'),setTimeout(()=>{i("#bme-drawing-instruction").fadeOut(500,function(){i(this).remove()})},4e3),this.clickDrawingListener=google.maps.event.addListener(this.map,"click",e=>{this.addClickPoint(e.latLng)}),this.map.setOptions({disableDoubleClickZoom:!0}),this.doubleClickListener=google.maps.event.addListener(this.map,"dblclick",e=>{e.domEvent&&(e.domEvent.preventDefault(),e.domEvent.stopPropagation()),this.isClickDrawing&&this.completeClickDrawing()}),this.map.setOptions({draggableCursor:"crosshair"})},addClickPoint(e){this.isClickDrawing&&(this.clickDrawingPath.push(e),this.clickDrawingMarkers||(this.clickDrawingMarkers=[]),this.createClickMarker(e,this.clickDrawingPath.length),this.clickDrawingPolygon&&this.clickDrawingPolygon.setMap(null),this.clickDrawingPath.length>=2&&(this.clickDrawingPolygon=new google.maps.Polygon({paths:this.clickDrawingPath,fillColor:"#2196F3",fillOpacity:.15,strokeColor:"#2196F3",strokeWeight:2,clickable:!1,editable:!1,draggable:!1}),this.clickDrawingPolygon.setMap(this.map)),1===this.clickDrawingPath.length?this.showDrawingFeedback("Point 1 added. Need 2 more points minimum."):2===this.clickDrawingPath.length?this.showDrawingFeedback("Point 2 added. Need 1 more point minimum."):3===this.clickDrawingPath.length&&this.showDrawingFeedback("Minimum 3 points reached! Double-click or use Complete Shape button to finish."))},completeClickDrawing(){if(!this.isClickDrawing||this.clickDrawingPath.length<3){const e=i,t=`<div id="bme-drawing-error" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(220, 53, 69, 0.9); color: white; padding: 15px; border-radius: 8px; z-index: 10001; text-align: center;">\n        <p style="margin: 0;">Need at least 3 points to create a polygon</p>\n        <p style="margin: 5px 0 0 0; font-size: 14px;">You have ${this.clickDrawingPath.length} point${1===this.clickDrawingPath.length?"":"s"}</p>\n      </div>`;return e("body").append(t),void setTimeout(()=>{e("#bme-drawing-error").fadeOut(500,function(){e(this).remove()})},3e3)}this.clickDrawingMarkers&&(this.clickDrawingMarkers.forEach(e=>{e.map?e.map=null:e.setMap&&e.setMap(null)}),this.clickDrawingMarkers=[]),this.clickDrawingPolygon&&(this.clickDrawingPolygon.setMap(null),this.clickDrawingPolygon=null);const e=new google.maps.Polygon({paths:this.clickDrawingPath,strokeColor:"#2196F3",strokeOpacity:.8,strokeWeight:2,fillColor:"#2196F3",fillOpacity:.15,clickable:!0,editable:!1,draggable:!1,map:this.map});this.handlePolygonComplete(e),this.cleanupClickDrawing()},cancelClickDrawing(){this.cleanupClickDrawing(),this.exitDrawingMode()},cleanupClickDrawing(){this.isClickDrawing=!1,this.clickDrawingPolygon&&(this.clickDrawingPolygon.setMap(null),this.clickDrawingPolygon=null),this.clickDrawingMarkers&&(this.clickDrawingMarkers.forEach(e=>{e.map?e.map=null:e.setMap&&e.setMap(null)}),this.clickDrawingMarkers=[]),this.clickDrawingListener&&(google.maps.event.removeListener(this.clickDrawingListener),this.clickDrawingListener=null),this.doubleClickListener&&(google.maps.event.removeListener(this.doubleClickListener),this.doubleClickListener=null),this.map&&this.map.setOptions({draggableCursor:null,disableDoubleClickZoom:!1}),this.clickDrawingPath=[],i("#bme-drawing-instruction").remove(),i("#bme-drawing-feedback").remove()},async createClickMarker(e,t){this.clickDrawingMarkers||(this.clickDrawingMarkers=[]);try{this.markerLibrary||(this.markerLibrary=await google.maps.importLibrary("marker"));const o=new this.markerLibrary.PinElement({scale:.8,background:"#2196F3",borderColor:"#1976D2",glyphColor:"white",glyph:t.toString()}),i=new this.markerLibrary.AdvancedMarkerElement({map:this.map,position:e,content:o.element,title:`Point ${t}`});this.clickDrawingMarkers.push(i)}catch(o){this.createFallbackCircleMarker(e,t)}},createFallbackCircleMarker(e,t){const o=new google.maps.Circle({map:this.map,center:e,radius:8,fillColor:"#2196F3",fillOpacity:1,strokeColor:"#1976D2",strokeWeight:2,clickable:!1});this.clickDrawingMarkers||(this.clickDrawingMarkers=[]),this.clickDrawingMarkers.push(o)},showDrawingFeedback(e){const t=i;t("#bme-drawing-feedback").remove();const o=`<div id="bme-drawing-feedback" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; z-index: 10002; font-size: 14px; text-align: center;">\n      ${e}\n    </div>`;t("body").append(o),setTimeout(()=>{t("#bme-drawing-feedback").fadeOut(500,function(){t(this).remove()})},3e3)},toggleMapControlsVisibility(e){const t=i;if(window.innerWidth<=768){const o=t("#bme-map-controls");"map"===e?(o.removeClass("force-hidden").show(),this.updatePolygonUI()):(o.addClass("force-hidden").hide(),t("#bme-drawing-panel").removeClass("active"))}}},s={setupPropertyTypeSelectors(){const e=i,t=e("#bme-property-type-select"),o=e("#bme-property-type-mobile-container");if(!t.length||!o.length)return;const a=t.clone().attr("id","bme-property-type-select-modal").removeClass("bme-control-select");o.append(a),t.on("change",function(){a.val(e(this).val())}),a.on("change",function(){t.val(e(this).val()).trigger("change")})},centerOnUserLocation(){const e=n,t=i;if(!navigator.geolocation)return alert("Geolocation is not supported by your browser."),void t("#bme-nearby-toggle").prop("checked",!1);navigator.geolocation.getCurrentPosition(async t=>{const o="mapbox"===bmeMapData.provider,i=o?[t.coords.longitude,t.coords.latitude]:{lat:t.coords.latitude,lng:t.coords.longitude};if(e.isNearbySearchActive=!0,MLDLogger.debug("Manual nearby location obtained",{lat:t.coords.latitude,lng:t.coords.longitude}),"google"===bmeMapData.provider&&window.google&&window.google.maps)try{const a=new google.maps.Geocoder,n={lat:t.coords.latitude,lng:t.coords.longitude};a.geocode({location:n},async(t,a)=>{if("OK"===a&&t[0]){let a=null,n=null;for(let e=0;e<Math.min(t.length,3);e++){for(let o=0;o<t[e].address_components.length;o++){const i=t[e].address_components[o],s=i.types;s.includes("locality")&&!a&&(a=i.long_name,MLDLogger.debug("Found city in locality",{city:a})),!a&&(s.includes("neighborhood")||s.includes("sublocality")||s.includes("sublocality_level_1"))||(!a&&s.includes("postal_town")&&(a=i.long_name,MLDLogger.debug("Found city in postal_town",{city:a})),s.includes("administrative_area_level_1")&&(n=i.short_name))}if(a)break}if(!a&&t[0]&&MLDLogger.debug("Could not find city, full geocode result:",{formatted_address:t[0].formatted_address,components:t[0].address_components.map(e=>({long_name:e.long_name,types:e.types}))}),MLDLogger.debug("Detected location (manual)",{city:a,state:n}),a){const t=await s.checkCityInDatabase(a);if(t.exists){MLDLogger.debug("City found in database, adding to filters (manual)",{city:a,exactName:t.exactName,count:t.count});const n=t.exactName||a;if(e.keywordFilters.City||(e.keywordFilters.City=new Set),e.keywordFilters.City.add(n),"undefined"!=typeof MLD_Filters){MLD_Filters.keywordFilters||(MLD_Filters.keywordFilters={}),MLD_Filters.keywordFilters.City&&MLD_Filters.keywordFilters.City instanceof Set||(MLD_Filters.keywordFilters.City=new Set),MLD_Filters.keywordFilters.City.add(n),"function"==typeof MLD_Filters.renderFilterTags?MLD_Filters.renderFilterTags():"function"==typeof MLD_Filters.updateFilterTags&&MLD_Filters.updateFilterTags();const e=document.querySelectorAll(`.filter-checkbox[data-filter="City"][value="${n}"]`);e.forEach(e=>{e.checked=!0}),e.length}"undefined"!=typeof MLD_CityBoundaries&&setTimeout(()=>{MLD_CityBoundaries.updateBoundariesFromFilters()},1500),e.map.setZoom(15),e.map.setCenter(i),MLD_Markers.createUserLocationMarker(i,o),e.isLoadingAfterGeolocation=!0,setTimeout(()=>{MLD_API.refreshMapListings(!0)},250)}else MLDLogger.debug("City not in database, using nearby mode only (manual)",{city:a}),e.map.setZoom(15),e.map.setCenter(i),MLD_Markers.createUserLocationMarker(i,o),e.isLoadingAfterGeolocation=!0,setTimeout(()=>{MLD_API.refreshMapListings(!0)},250)}else e.map.setZoom(15),e.map.setCenter(i),MLD_Markers.createUserLocationMarker(i,o),e.isLoadingAfterGeolocation=!0,setTimeout(()=>{MLD_API.refreshMapListings(!0)},250)}else e.map.setZoom(15),e.map.setCenter(i),MLD_Markers.createUserLocationMarker(i,o),e.isLoadingAfterGeolocation=!0,setTimeout(()=>{MLD_API.refreshMapListings(!0)},250)})}catch(t){MLDLogger.error("Error during geocoding (manual)",t),e.map.setZoom(15),e.map.setCenter(i),MLD_Markers.createUserLocationMarker(i,o),e.isLoadingAfterGeolocation=!0,setTimeout(()=>{MLD_API.refreshMapListings(!0)},250)}else e.map.setZoom(15),e.map.setCenter(i),MLD_Markers.createUserLocationMarker(i,o),e.isLoadingAfterGeolocation=!0,setTimeout(()=>{MLD_API.refreshMapListings(!0)},250)},o=>{e.isNearbySearchActive=!1;let i="";switch(o.code){case o.PERMISSION_DENIED:i="Location access was denied. Please enable location permissions for this site in your browser settings.",MLDLogger.debug("Geolocation permission denied");break;case o.POSITION_UNAVAILABLE:i="Location information is unavailable. Please check your device settings and try again.",MLDLogger.debug("Geolocation position unavailable");break;case o.TIMEOUT:i="Location request timed out. Please try again.",MLDLogger.debug("Geolocation request timed out");break;default:i="Unable to retrieve your location. Please try again or check your browser settings.",MLDLogger.debug("Geolocation unknown error",o)}alert(i),t("#bme-nearby-toggle").prop("checked",!1),MLD_Markers.removeUserLocationMarker()},{enableHighAccuracy:!1,timeout:1e4,maximumAge:6e4})},attemptGeolocationWithCityDetection(){const e=n,t=i;if(a.mark("Geolocation Started"),!navigator.geolocation)return MLDLogger.debug("Geolocation not supported, defaulting to Boston"),void this.setDefaultBostonView();MLDLogger.debug("Attempting geolocation with city detection"),navigator.geolocation.getCurrentPosition(async o=>{a.mark("Geolocation Success");const i="mapbox"===bmeMapData.provider,n=i?[o.coords.longitude,o.coords.latitude]:{lat:o.coords.latitude,lng:o.coords.longitude};if(MLDLogger.debug("Geolocation successful",{lat:o.coords.latitude,lng:o.coords.longitude}),"google"===bmeMapData.provider&&window.google&&window.google.maps){a.mark("Geocoding Started");try{const s=new google.maps.Geocoder,r={lat:o.coords.latitude,lng:o.coords.longitude};s.geocode({location:r},async(o,s)=>{if(a.mark("Geocoding Complete"),"OK"===s&&o[0]){let s=null,r=null;for(let e=0;e<Math.min(o.length,3);e++){for(let t=0;t<o[e].address_components.length;t++){const i=o[e].address_components[t],a=i.types;a.includes("locality")&&!s&&(s=i.long_name,MLDLogger.debug("Found city in locality",{city:s})),!s&&a.includes("sublocality_level_1")&&(s=i.long_name,MLDLogger.debug("Found city in sublocality_level_1",{city:s})),!s&&a.includes("postal_town")&&(s=i.long_name,MLDLogger.debug("Found city in postal_town",{city:s})),a.includes("administrative_area_level_1")&&(r=i.short_name)}if(s)break}if(!s&&o[0]&&(o[0].address_components.forEach(e=>{}),MLDLogger.debug("Could not find city, full geocode result:",{formatted_address:o[0].formatted_address,components:o[0].address_components.map(e=>({long_name:e.long_name,types:e.types}))})),MLDLogger.debug("Detected location",{city:s,state:r}),s){a.mark("City Check Started");const o=await this.checkCityInDatabase(s);if(a.mark("City Check Complete"),o.exists){MLDLogger.debug("City found in database, adding to filters",{city:s,exactName:o.exactName,count:o.count});const t=o.exactName||s;if(e.keywordFilters.City||(e.keywordFilters.City=new Set),e.keywordFilters.City.add(t),"undefined"!=typeof MLD_Filters){MLD_Filters.keywordFilters||(MLD_Filters.keywordFilters={}),MLD_Filters.keywordFilters.City&&MLD_Filters.keywordFilters.City instanceof Set||(MLD_Filters.keywordFilters.City=new Set),MLD_Filters.keywordFilters.City.add(t),"function"==typeof MLD_Filters.renderFilterTags?MLD_Filters.renderFilterTags():"function"==typeof MLD_Filters.updateFilterTags&&MLD_Filters.updateFilterTags();const e=document.querySelectorAll(`.filter-checkbox[data-filter="City"][value="${t}"]`);e.forEach(e=>{e.checked=!0}),e.length}e.isNearbySearchActive=!0,e.map.setZoom(15),e.map.setCenter(n),MLD_Markers.createUserLocationMarker(n,i),e.isLoadingAfterGeolocation=!0,setTimeout(()=>{a.mark("Loading Listings"),"undefined"!=typeof MLD_API&&MLD_API.refreshMapListings?(MLDLogger.debug("Calling MLD_API.refreshMapListings with city filter"),MLD_API.refreshMapListings(!0)):(MLDLogger.error("MLD_API not available when trying to load listings!"),e.isLoadingAfterGeolocation=!1)},250),"undefined"!=typeof MLD_CityBoundaries&&setTimeout(()=>{MLD_CityBoundaries.updateBoundariesFromFilters()},1500)}else{MLDLogger.debug("City not in database, loading all listings",{city:s}),t("#bme-nearby-toggle").prop("checked",!1),e.isNearbySearchActive=!1,MLD_Markers.removeUserLocationMarker();const o=i?[-71.0589,42.3601]:{lat:42.3601,lng:-71.0589};e.map.setCenter(o),e.map.setZoom(11),e.isLoadingAfterGeolocation=!0,setTimeout(()=>{a.mark("Loading Listings"),"undefined"!=typeof MLD_API&&MLD_API.refreshMapListings?(MLDLogger.debug("Calling MLD_API.refreshMapListings - city not in database"),MLD_API.refreshMapListings(!0)):(MLDLogger.error("MLD_API not available when trying to load listings!"),e.isLoadingAfterGeolocation=!1)},250)}}else{MLDLogger.debug("Could not detect city, loading all listings"),t("#bme-nearby-toggle").prop("checked",!1),e.isNearbySearchActive=!1;const o=i?[-71.0589,42.3601]:{lat:42.3601,lng:-71.0589};e.map.setCenter(o),e.map.setZoom(11),MLD_API.refreshMapListings(!0)}}else{MLDLogger.debug("Geocoding failed, loading all listings"),t("#bme-nearby-toggle").prop("checked",!1),e.isNearbySearchActive=!1;const o=i?[-71.0589,42.3601]:{lat:42.3601,lng:-71.0589};e.map.setCenter(o),e.map.setZoom(11),MLD_API.refreshMapListings(!0)}})}catch(o){MLDLogger.error("Error during geocoding",o),t("#bme-nearby-toggle").prop("checked",!1),e.isNearbySearchActive=!1;const a=i?[-71.0589,42.3601]:{lat:42.3601,lng:-71.0589};e.map.setCenter(a),e.map.setZoom(11),MLD_API.refreshMapListings(!0)}}else{t("#bme-nearby-toggle").prop("checked",!1),e.isNearbySearchActive=!1;const o=i?[-71.0589,42.3601]:{lat:42.3601,lng:-71.0589};e.map.setCenter(o),e.map.setZoom(11),MLD_API.refreshMapListings(!0)}},e=>{MLDLogger.debug("Geolocation denied or failed, defaulting to Boston"),this.setDefaultBostonView()},{timeout:5e3,maximumAge:0,enableHighAccuracy:!1})},async checkCityInDatabase(e){const t=performance.now();if(bmeMapData.available_cities&&Array.isArray(bmeMapData.available_cities)){const o=e.toLowerCase(),i=bmeMapData.available_cities.find(e=>e.name_lower===o);if(i){const a=performance.now()-t;MLDLogger.debug("City found in pre-loaded list",{city:e,exactName:i.name,count:i.count,time:a.toFixed(0)+"ms"});const n={exists:!0,exactName:i.name,count:i.count},s=`mld_city_${o}`;return sessionStorage.setItem(s,JSON.stringify(n)),n}performance.now();return MLDLogger.debug("City not found in pre-loaded list",{city:e}),{exists:!1}}const o=`mld_city_${e.toLowerCase()}`,a=sessionStorage.getItem(o);if(a)try{const e=JSON.parse(a);performance.now();return MLDLogger.debug("Using cached city check result",e),e}catch(e){}return MLDLogger.warning("Pre-loaded cities not available, falling back to AJAX"),new Promise(t=>{MLDLogger.debug("Checking city in database via AJAX",{city:e});const a=bmeMapData.ajaxUrl||bmeMapData.ajax_url||"/wp-admin/admin-ajax.php",n=bmeMapData.nonce||bmeMapData.security||"";i.ajax({url:a,type:"POST",dataType:"json",data:{action:"check_city_exists",security:n,city:e},success:function(e){if(e.success&&e.data){performance.now();MLDLogger.debug("City check response",e.data);const i={exists:e.data.exists,exactName:e.data.exact_name,count:e.data.count};sessionStorage.setItem(o,JSON.stringify(i)),t(i)}else MLDLogger.info("City check failed",e),t({exists:!1})},error:function(e,o,i){e.responseText&&(e.responseText.includes("<!DOCTYPE")||e.responseText.includes("<html"))&&MLDLogger.error("Received HTML instead of JSON. AJAX endpoint not reached correctly."),MLDLogger.error("Failed to check city in database",{status:o,error:i}),t({exists:!1})}})})},setDefaultBostonView(){const e=n,t=i;MLDLogger.debug("Setting default Boston view"),t("#bme-nearby-toggle").prop("checked",!1),e.isNearbySearchActive=!1;const o="mapbox"===bmeMapData.provider?[-71.0589,42.3601]:{lat:42.3601,lng:-71.0589};e.map.setCenter(o),e.map.setZoom(11),MLD_Markers.removeUserLocationMarker(),MLD_API.refreshMapListings(!0)},debounce(e,t){let o;return function(...i){const a=this;clearTimeout(o),o=setTimeout(()=>e.apply(a,i),t)}},slugify(e){return"string"!=typeof e?"":e.toLowerCase().replace(/[^a-z0-9_\-]/g,"")},formatCurrency(e){const t=Number(e);return isNaN(t)?"":new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(t)},formatPrice(e){return e=parseFloat(e),isNaN(e)?"":e<1e4?`$${parseInt(e).toLocaleString("en-US")}`:e<1e6?`$${Math.round(e/1e3)}k`:`$${(e/1e6).toFixed(e<1e7?2:1)}m`},getNormalizedCenter(e){const t=e.getCenter();return"function"==typeof t.lat?{lat:t.lat(),lng:t.lng()}:{lat:t.lat,lng:t.lng}},getMapBounds(){const e=n.map;if(!e)return null;try{if("google"===bmeMapData.provider){const t=e.getBounds();if(!t)return null;const o=t.getNorthEast(),i=t.getSouthWest();return{north:o.lat(),south:i.lat(),east:o.lng(),west:i.lng()}}const t=e.getBounds();return t?{north:t.getNorth(),south:t.getSouth(),east:t.getEast(),west:t.getWest()}:null}catch(e){return MLDLogger.error("Error getting map bounds:",e),null}},handleResize(){const e=n.map;if(e){if("google"===bmeMapData.provider){const t=e.getCenter();google.maps.event.trigger(e,"resize"),e.setCenter(t)}else e.resize();MLD_API.refreshMapListings(!1)}},initListingsResize(){const e=i,t=e("#bme-resize-handle"),o=e("#bme-listings-list-container"),a=e("#bme-half-map-wrapper");if(!t.length||!o.length)return;let r=!1,l=0,d=0;t.addClass("first-load");const c=t.find(".bme-resize-handle-tooltip");setTimeout(()=>{c.css("opacity","1"),setTimeout(()=>{c.css("opacity","")},3e3)},500),setTimeout(()=>{t.removeClass("first-load")},4e3),t.on("mousedown touchstart",function(t){r=!0,l=t.type.includes("touch")?t.originalEvent.touches[0].pageX:t.pageX,d=o.outerWidth(),e("body").css("cursor","col-resize"),e("body").css("user-select","none"),t.preventDefault()}),e(document).on("mousemove touchmove",function(e){if(!r)return;const t=e.type.includes("touch")?e.originalEvent.touches[0].pageX:e.pageX,i=.8*a.width();let c=d+(l-t);c=Math.max(280,Math.min(c,i)),o.css("flex",`0 0 ${c}px`),s.updateListingsColumns(c),n.map&&s.handleResize()}),e(document).on("mouseup touchend",function(){r&&(r=!1,e("body").css("cursor",""),e("body").css("user-select",""))}),e(window).on("resize",s.debounce(function(){const e=o.outerWidth();s.updateListingsColumns(e)},250))},updateListingsColumns(e){const t=i("#bme-listings-list-container");if(!t.length)return;let o=1;e>=590&&(o=2),e>=890&&(o=3),e>=1190&&(o=4),t.attr("data-cols",o)},initEventDelegation(){const e=i;e("body").on("click",".bme-card-image a, .bme-view-details-btn",e=>e.stopPropagation()),e("body").on("click",".bme-popout-btn",function(t){t.stopPropagation();const o=e(this).closest(".bme-popup-card-wrapper").data("listingData");o&&(s.openPropertyInNewWindow(o),MLD_Markers.closeListingPopup(o.ListingId))}),e("body").on("click",".bme-view-photos-btn",function(t){t.stopPropagation(),t.preventDefault();const o=e(this).data("listing-id");o&&"undefined"!=typeof MLD_Gallery&&MLD_Gallery.open(o)}),window.addEventListener("beforeunload",()=>{for(const e in n.openPopoutWindows)n.openPopoutWindows[e]&&!n.openPopoutWindows[e].closed&&n.openPopoutWindows[e].close()}),e("#bme-nearby-toggle").on("change",function(){if(e(this).is(":checked"))s.centerOnUserLocation();else{n.isNearbySearchActive=!1,MLD_Markers.removeUserLocationMarker();const e=n;let t=!1;if(e.keywordFilters&&e.keywordFilters.City&&(t=e.keywordFilters.City.size>0,delete e.keywordFilters.City),"undefined"!=typeof MLD_Filters&&MLD_Filters.keywordFilters&&MLD_Filters.keywordFilters.City&&(t=t||MLD_Filters.keywordFilters.City.size>0,delete MLD_Filters.keywordFilters.City),t){"undefined"!=typeof MLD_Filters&&"function"==typeof MLD_Filters.renderFilterTags&&MLD_Filters.renderFilterTags();document.querySelectorAll('.filter-checkbox[data-filter="City"]:checked').forEach(e=>{e.checked=!1}),"undefined"!=typeof MLD_CityBoundaries&&"function"==typeof MLD_CityBoundaries.updateBoundariesFromFilters&&MLD_CityBoundaries.updateBoundariesFromFilters(),MLD_API.refreshMapListings(!0)}}}),e("body").on("click","#bme-draw-toggle",function(t){t.preventDefault();const o=e("#bme-half-map-wrapper"),i=e('.bme-view-mode-btn[data-mode="map"]'),a=e("#bme-draw-toggle");(o.hasClass("list-view")||o.hasClass("view-mode-list")||e('.bme-view-mode-btn[data-mode="list"]').hasClass("active"))&&!a.hasClass("active")&&(MLDLogger.info("Switching to map view for draw functionality"),i.trigger("click")),n.toggleDrawingMode()}),e("body").on("click","#bme-reset-button",function(e){e.preventDefault(),confirm("Are you sure you want to reset all drawn shapes?")&&n.clearAllPolygons()}),e("body").on("click","#bme-complete-shape-button",function(e){e.preventDefault(),n.completeCurrentShape()}),e("body").on("click",".bme-polygon-name",function(t){t.stopPropagation();const o=e(this),i=o.siblings(".bme-polygon-name-input");o.hide(),i.show().focus().select()}),e("body").on("blur",".bme-polygon-name-input",function(){n.saveShapeName(e(this))}),e("body").on("keypress",".bme-polygon-name-input",function(t){13===t.which&&(t.preventDefault(),e(this).blur())}),window.addEventListener("resize",s.debounce(s.handleResize,250))},updateModalVisibility(){const e=i;if(["Residential Lease","Commercial Lease"].includes(n.selectedPropertyType))e("#bme-rental-filters").show(),e("#bme-filter-status-dropdown .bme-select-option").each(function(){const t=e(this).find('input[type="checkbox"]');"Active"!==t.val()?(e(this).hide(),t.prop("checked",!1).prop("disabled",!0)):(e(this).show(),t.prop("checked",!0).prop("disabled",!1))}),n.modalFilters.status=["Active"],e("#bme-filter-status-display .bme-select-text").text("Active");else if(["Residential","Residential Income","Commercial Sale","Business Opportunity","Land"].includes(n.selectedPropertyType)){e("#bme-rental-filters").hide(),e("#bme-filter-status-dropdown .bme-select-option").show(),e('#bme-filter-status-dropdown input[type="checkbox"]').prop("disabled",!1);e('#bme-filter-status-dropdown input[type="checkbox"]:checked').length>0||(e('#bme-filter-status-dropdown input[value="Active"]').prop("checked",!0),e("#bme-filter-status-display .bme-select-text").text("Active"))}else e("#bme-rental-filters").hide(),e("#bme-filter-status-dropdown .bme-select-option").show(),e('#bme-filter-status-dropdown input[type="checkbox"]').prop("disabled",!1)},restoreStateFromUrl(){const e=window.location.hash.substring(1);if(!e)return!1;const t=new URLSearchParams(e);if(0===[...t.keys()].length)return!1;const o={},i=MLD_Filters.getModalDefaults(),a=MLD_Filters.getModalDefaults();for(const[e,s]of t.entries()){const t=s.split(",");if("PropertyType"===e)n.selectedPropertyType=s;else if(["City","Building","Neighborhood","Postal Code","Street Name","MLS Number","Address"].includes(e))o[e]=new Set(t);else if("polygon_shapes"===e)try{s.split("|").forEach(e=>{const t=JSON.parse(decodeURIComponent(e));if(Array.isArray(t)&&t.length>=3&&"google"===bmeMapData.provider){const e=t.map(e=>new google.maps.LatLng(e[0],e[1])),o=new google.maps.Polygon({paths:e,fillColor:"#2196F3",fillOpacity:.2,strokeColor:"#2196F3",strokeWeight:2,clickable:!0});o.setMap(n.map);const i={id:"polygon_"+Date.now()+"_"+Math.random(),coordinates:t,googlePolygon:o,mapboxId:null};n.drawnPolygons.push(i),google.maps.event.addListener(o,"click",()=>{n.deletePolygon(i.id)})}}),n.drawnPolygons.length>0&&n.updatePolygonUI()}catch(e){MLDLogger.error("Error restoring polygon shapes from URL:",e)}else a.hasOwnProperty(e)&&("boolean"==typeof a[e]?i[e]="true"===s:Array.isArray(a[e])?i[e]=t:i[e]=s)}return n.keywordFilters=o,n.modalFilters=i,MLD_Filters.renderFilterTags(),MLD_Filters.restoreModalUIToState(),!0},updateUrlHash(){const e=new URLSearchParams,t=MLD_Filters.getCombinedFilters();for(const o in t){const i=t[o];Array.isArray(i)||i instanceof Set?Array.from(i).length>0&&e.set(o,Array.from(i).join(",")):i&&e.set(o,i.toString())}if(n.drawnPolygons.length>0){const t=n.drawnPolygons.map(e=>encodeURIComponent(JSON.stringify(e.coordinates)));e.set("polygon_shapes",t.join("|"))}const o="#"+e.toString();window.location.hash!==o&&history.replaceState(null,"",o)},updateSidebarList(e){const t=i,o=t("#bme-listings-list-container .bme-listings-grid");0!==o.length&&(o.empty(),e&&0!==e.length?(e.forEach(e=>{const i=t(this.createCardHTML(e,"sidebar"));i.on("mouseenter",()=>MLD_Markers.highlightMarker(e.ListingId,"hover")).on("mouseleave",()=>{MLD_Markers.highlightMarker(e.ListingId,"none"),MLD_Markers.reapplyActiveHighlights()}),o.append(i)}),t(document).trigger("mld:listingsLoaded")):o.html('<p class="bme-list-placeholder">No listings found.</p>'))},updateListingCountIndicator(e,t){const o=i("#bme-listings-count-indicator");t>0?o.text(`Showing ${e} of ${t} Listings`).show():o.hide()},panTo(e){const t=parseFloat(e.Latitude),o=parseFloat(e.Longitude);if(isNaN(t)||isNaN(o))return void MLDLogger.warning("Invalid coordinates for listing:",e);const i={lat:t,lng:o};"google"===bmeMapData.provider?n.map.panTo(i):n.map.panTo([i.lng,i.lat])},fitMapToBounds(e){const t=n.map;if("google"===bmeMapData.provider){const o=new google.maps.LatLngBounds;let i=!1;if(e.forEach(e=>{const t=parseFloat(e.Latitude),a=parseFloat(e.Longitude);isNaN(t)||isNaN(a)||(o.extend(new google.maps.LatLng(t,a)),i=!0)}),i&&!o.isEmpty())try{t.fitBounds(o)}catch(e){MLDLogger.error("Error fitting bounds:",e),t.setCenter({lat:42.3601,lng:-71.0589}),t.setZoom(10)}else MLDLogger.warning("No valid coordinates found in listings, using default location"),t.setCenter({lat:42.3601,lng:-71.0589}),t.setZoom(10)}else{const o=new mapboxgl.LngLatBounds;let i=!1;e.forEach(e=>{const t=parseFloat(e.Latitude),a=parseFloat(e.Longitude);isNaN(t)||isNaN(a)||(o.extend([a,t]),i=!0)}),i&&!o.isEmpty()?t.fitBounds(o,{padding:100}):(MLDLogger.warning("No valid coordinates found in listings, using default location"),t.setCenter([-71.0589,42.3601]),t.setZoom(10))}n.hasUrlFilters&&(n.hasUrlFilters=!1)},openPropertyInNewWindow(e){const t=n,o=e.ListingId;if(t.openPopoutWindows[o]&&!t.openPopoutWindows[o].closed)return void t.openPopoutWindows[o].focus();const i=window.open("",o,"width=480,height=750,menubar=no,toolbar=no,location=no,resizable=yes,scrollbars=yes");if(!i)return void alert("Please allow pop-ups for this website.");t.openPopoutWindows[o]=i;let a="";Array.from(document.styleSheets).forEach(e=>{try{e.href&&(a+=`<link rel="stylesheet" href="${e.href}">`)}catch(t){MLDLogger.warning("Could not access stylesheet due to CORS policy: ",e.href)}});const s=this.createCardHTML(e,"window");i.document.write(`<html><head><title>${e.StreetNumber} ${e.StreetName} - Property Details</title>${a}<style>\n\t\t\tbody { \n\t\t\t\tpadding: 20px; \n\t\t\t\tbackground-color: #f0f2f5; \n\t\t\t\tmargin: 0;\n\t\t\t\toverflow-y: auto;\n\t\t\t\tmin-height: 100vh;\n\t\t\t\tbox-sizing: border-box;\n\t\t\t} \n\t\t\t.bme-listing-card { \n\t\t\t\tbox-shadow: none; \n\t\t\t\tborder: none; \n\t\t\t\tmargin-bottom: 30px; /* Extra space at bottom */\n\t\t\t\theight: auto !important; /* Ensure card expands to content */\n\t\t\t\tmax-width: 100%;\n\t\t\t}\n\t\t\t/* Hide popout button and close button in popup window */\n\t\t\t.bme-popout-btn,\n\t\t\t.bme-popup-close { \n\t\t\t\tdisplay: none !important; \n\t\t\t}\n\t\t\t/* Ensure details section is fully visible */\n\t\t\t.bme-card-details {\n\t\t\t\tpadding-bottom: 20px;\n\t\t\t}\n\t\t</style></head><body>${s}</body></html>`),i.document.close(),i.addEventListener("beforeunload",()=>{MLD_Markers.highlightMarker(o,"none"),delete t.openPopoutWindows[o]})},createCardHTML(e,t="sidebar"){const o=e.photo_url||"https://placehold.co/420x280/eee/ccc?text=No+Image",i=`${e.StreetNumber||""} ${e.StreetName||""}`.trim(),a=`${e.City}, ${e.StateOrProvince} ${e.PostalCode}`,n=`${i}${e.UnitNumber?" #"+e.UnitNumber:""}, ${a}`,s=(parseInt(e.BathroomsFull)||0)+.5*(parseInt(e.BathroomsHalf)||0),r=parseFloat(e.OriginalListPrice)>parseFloat(e.ListPrice);let l="";const d="string"==typeof e.OpenHouseData?JSON.parse(e.OpenHouseData||"[]"):e.OpenHouseData||[],c=Array.isArray(d)&&d.length>0?'<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-left: 6px; vertical-align: middle; opacity: 0.8;"><path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.707 1.5ZM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5 5 5Z"/><path d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5V15H9v-1.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5V15H6v-2.5Z"/></svg>':"",g=`$${parseInt(e.ListPrice).toLocaleString("en-US")}${c}`;if(Array.isArray(d)&&d.length>0){const e=new Date,t="America/New_York",o=d.map(e=>({...e,startDateTime:new Date(e.OpenHouseStartTime.endsWith("Z")?e.OpenHouseStartTime:e.OpenHouseStartTime+"Z"),endDateTime:new Date(e.OpenHouseEndTime.endsWith("Z")?e.OpenHouseEndTime:e.OpenHouseEndTime+"Z")})),i=o.find(t=>t.startDateTime<=e&&t.endDateTime>e);if(i){l+=`<div class="bme-card-tag open-house open-now">OPEN NOW UNTIL ${i.endDateTime.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",timeZone:t,hour12:!0}).replace(" ","")}</div>`}else{const i=o.filter(t=>t.startDateTime>e).sort((e,t)=>e.startDateTime-t.startDateTime);if(i.length>0){const e=i[0].startDateTime;l+=`<div class="bme-card-tag open-house">OPEN ${e.toLocaleDateString("en-US",{weekday:"short",timeZone:t}).toUpperCase()}, ${e.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",timeZone:t,hour12:!0}).replace(" ","")}</div>`}}}if(r&&(l+='<div class="bme-card-tag price-drop">Price Drop</div>'),e.StandardStatus&&"Active"!==e.StandardStatus){l+=`<div class="bme-card-tag status ${"closed"===e.StandardStatus.toLowerCase()?"sold":"pending"===e.StandardStatus.toLowerCase()?"pending":""}">${e.StandardStatus}</div>`}let p="";if(e.AssociationFee&&parseFloat(e.AssociationFee)>0){const t=(e.AssociationFeeFrequency||"Monthly").slice(0,2).toLowerCase();p+=`<span>$${parseInt(e.AssociationFee).toLocaleString()}/${t} HOA</span>`}e.GarageSpaces&&parseInt(e.GarageSpaces)>0&&(p+=`<span>${e.GarageSpaces} Garage ${parseInt(e.GarageSpaces)>1?"Spaces":"Space"}</span>`);let h="",m=`<img src="${o}" alt="${n}" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/420x280/eee/ccc?text=No+Image';">`,u="";if("sidebar"===t)m=`<a href="/property/${e.ListingId}">${m}</a>`;else if("popup"===t||"window"===t){if("popup"===t){h=`<button class="bme-popout-btn" title="Pop out card">${'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6 1h6v6h-1V2.707L5.354 9.354l-.708-.708L11.293 2H6V1z"/><path d="M2 3.5A1.5 1.5 0 0 1 3.5 2H5v1H3.5a.5.5 0 0 0-.5.5v10a.5.5 0 0 0 .5.5h10a.5.5 0 0 0 .5-.5V11h1v2.5a1.5 1.5 0 0 1-1.5 1.5h-10A1.5 1.5 0 0 1 2 13.5V3.5z"/></svg>'}</button>`}u=`<a href="/property/${e.ListingId}" class="bme-view-details-btn">View Details</a>`}return`\n\t\t\t<div class="bme-listing-card" data-listing-id="${e.ListingId}">\n\t\t\t\t<div class="bme-card-image">\n\t\t\t\t\t${m}\n\t\t\t\t\t<div class="bme-card-image-overlay">\n\t\t\t\t\t\t<div class="bme-card-tags">${l}</div>\n\t\t\t\t\t\t<button class="bme-view-photos-btn" data-listing-id="${e.ListingId}" title="View all photos">\n\t\t\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">\n\t\t\t\t\t\t\t\t<path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>\n\t\t\t\t\t\t\t\t<path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t<span>View all photos</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t ${h}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="bme-card-details">\n\t\t\t\t\t<div class="bme-card-header">\n\t\t\t\t\t\t<div class="bme-card-price">${g}</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="bme-card-specs">\n\t\t\t\t\t\t<span><strong>${e.BedroomsTotal||0}</strong> bds</span>\n\t\t\t\t\t\t<span class="bme-spec-divider"></span>\n\t\t\t\t\t\t<span><strong>${s}</strong> ba</span>\n\t\t\t\t\t\t<span class="bme-spec-divider"></span>\n\t\t\t\t\t\t<span><strong>${parseInt(e.LivingArea||0).toLocaleString()}</strong> sqft</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="bme-card-address">\n\t\t\t\t\t\t<p>${i}${e.UnitNumber?` #${e.UnitNumber}`:""}</p>\n\t\t\t\t\t\t<p>${a}</p>\n\t\t\t\t\t</div>\n\t\t\t\t\t${p?`<div class="bme-card-secondary-info">${p}</div>`:""}\n\t\t\t\t\t${u}\n\t\t\t\t</div>\n\t\t\t</div>`},getIconForType(e){const t='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>',o='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22v-5"></path><path d="M20 17v-5"></path><path d="M4 17v-5"></path><path d="M12 12V2l-7 5v5l7-5z"></path><path d="M20 12V2l-7 5v5l7-5z"></path><path d="M4 12V2l7 5v5l-7-5z"></path></svg>',i='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22V8.2c0-.4.2-.8.5-1L10 3l6.5 4.2c.3.2.5.6.5 1V22"/><path d="M14 14v-3.1c0-.4.2-.8.5-1L20 6l-6.5-4.2c-.3-.2-.5-.6-.5-1V-3"/><path d="M10 22v-2.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5V22"/><path d="M10 14H4v8h6Z"/></svg>',a='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 3v18"/><path d="M17 3v18"/><path d="M3 7h18"/><path d="M3 12h18"/><path d="M3 17h18"/></svg>',n='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6m-3-3h6"/></svg>',s='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M9 15h6"></path><path d="M12 12v6"></path></svg>',r='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 17v-2.1c0-.6.4-1.2 1-1.4l7-3.5c.6-.3 1.4-.3 2 0l7 3.5c.6.2 1 .8 1 1.4V17"/><path d="M22 17H2"/><path d="M2 17v2a1 1 0 0 0 1 1h18a1 1 0 0 0 1-1v-2"/><circle cx="8" cy="20" r="1"/><circle cx="16" cy="20" r="1"/></svg>',l='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 5H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Z"/><path d="M10 5V2"/><path d="M14 5V2"/><path d="M10 19v-5"/><path d="M14 19v-5"/></svg>',d='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V6h6.5a4.5 4.5 0 0 1 0 9H9Z"/></svg>',c='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12h-8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8Z"/><path d="M7 21h10"/><path d="M12 3v9"/><path d="M19 12v9H5v-9Z"/></svg>',g='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 8v4l2 2"/></svg>',p=e.toLowerCase();return p.includes("condo")?o:p.includes("single family")?t:p.includes("apartment")?a:p.includes("townhouse")||p.includes("attached")||p.includes("duplex")||p.includes("condex")?i:p.includes("family")||p.includes("units")?s:p.includes("cooperative")?n:p.includes("mobile")?r:p.includes("farm")||p.includes("equestrian")||p.includes("agriculture")?l:p.includes("parking")?d:p.includes("commercial")?c:g},initViewModeToggle(){const e=i,t=e("#bme-view-mode-toggle");e(".bme-map-ui-wrapper.bme-map-half"),e("#bme-listings-list-container"),e("#bme-resize-handle");if(!t.length||window.innerWidth>768)return;this.setViewMode("list"),t.on("click",".bme-view-mode-btn",function(){const t=e(this).data("mode");s.setViewMode(t)})},setViewMode(e){const t=i,o=t("#bme-view-mode-toggle"),a=(t(".bme-map-ui-wrapper.bme-map-half"),t("#bme-listings-list-container"),t("#bme-resize-handle"),t("#bme-half-map-wrapper"));t("#bme-map-controls");o.find(".bme-view-mode-btn").removeClass("active"),o.find(`[data-mode="${e}"]`).addClass("active"),a.removeClass("view-mode-list view-mode-map view-mode-split"),a.addClass(`view-mode-${e}`),window.innerWidth<=768&&(n.toggleMapControlsVisibility(e),"map"===e&&n.map?setTimeout(()=>{"google"===bmeMapData.provider&&google.maps.event?google.maps.event.trigger(n.map,"resize"):n.map.resize&&n.map.resize()},100):"list"===e&&n.isDrawingMode&&n.exitDrawingMode()),s.handleResize()},preventMobileZoom(){let e=document.querySelector('meta[name="viewport"]');e?e.content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no":(e=document.createElement("meta"),e.name="viewport",e.content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no",document.head.appendChild(e));let t=0;document.addEventListener("touchend",function(e){const o=Date.now();o-t<=300&&e.preventDefault(),t=o},!1)}},r={get_field_label(e){return bmeMapData&&bmeMapData.field_labels&&bmeMapData.field_labels[e]?bmeMapData.field_labels[e]:"string"!=typeof e?"":e.replace(/YN$|_FLAG$|Enabled$/,"").replace(/([A-Z])/g," $1").replace(/^MLSPIN /,"").replace(/^Has/,"").trim()}};var l;window.MLD_Map_App=n,window.MLD_Core=s,"undefined"!=typeof MLD_Filters&&(window.MLD_Filters=MLD_Filters),window.MLD_Utils=r,l=i,"undefined"!=typeof bmeMapData&&"google"!==bmeMapData.provider&&l(document).ready(()=>n.init()),window.resetMLDFirstLoad=function(){sessionStorage.removeItem("mld_map_loaded"),sessionStorage.removeItem("mld_navigated_away")}}},function(e){e.O(0,[96],function(){return t=127,e(e.s=t);var t});e.O()}]);
//# sourceMappingURL=map-bundle.072c89be.min.js.map